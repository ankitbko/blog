<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Device Code Flow in Azure AD using Python&#39;s requests module and MSAL</h1><p class="page-description">Sample on how to integrate requests with MSAL to achieve device code flow</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2020-08-17T00:00:00-05:00" itemprop="datePublished">
        Aug 17, 2020
      </time>
       â€¢ <span class="read-time" title="Estimated read time">
    
    
      1 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/blog/categories/#Python">Python</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#azure">azure</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#oauth">oauth</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#msal">msal</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#requests">requests</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#device code">device code</a>
        
      
      </p>
    

    
		<div class="d-flex flex-wrap flex-justify-start flex-items-center">
			<p class="page-description" style="margin-right: .5rem;">Source Code </p>
			<div class="page-description">
				<div class="px-2">
    <a href="https://github.com/ankitbko/python-requests-msal" role="button" target="_blank">
        <img class="notebook-badge-image" src="/blog/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

			</div>
		</div>
	
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <blockquote>
  <p>Repo: <a href="https://github.com/ankitbko/python-requests-msal">https://github.com/ankitbko/python-requests-msal</a>.</p>
</blockquote>

<p>If you have created any Python application that required integration with Azure Active Directory you would have most likely used an excellent library from Azure AD team called <a href="https://github.com/AzureAD/microsoft-authentication-library-for-python">MSAL for Python</a>. However there is no easy way to integrate it with <a href="https://requests.readthedocs.io/en/master/">requests</a> library which is a very popular HTTP library for Python.</p>

<p>I have written a sample application and reusable class to integrate Python requests library with MSAL to get AD token using <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-device-code">Device Code Flow</a>. Device Code Flow is typically used in a client side applications such as CLI. Therefore I have also implemented a <em>TokenCache</em> serialization/deserialization logic to persist the token in file system. This is similar to how <a href="https://docs.microsoft.com/en-us/cli/azure/get-started-with-azure-cli">Azure CLI</a> persists the token in <code class="language-plaintext highlighter-rouge">~/.azure</code> folder.</p>

<p>Feel free to copy and use <code class="language-plaintext highlighter-rouge">auth.py</code> and <code class="language-plaintext highlighter-rouge">rest_service.py</code> in your own project. The files depends upon following PyPI -</p>
<ul>
  <li><a href="https://pypi.org/project/msal/">msal</a></li>
  <li><a href="https://pypi.org/project/requests/">requests</a></li>
</ul>

<p>Initialize <code class="language-plaintext highlighter-rouge">DeviceCodeFlowTokenAuth</code> by passing <code class="language-plaintext highlighter-rouge">auth_config</code> object to it. <code class="language-plaintext highlighter-rouge">auth_config</code> must have</p>
<ul>
  <li>client_id: Azure AD Application ID</li>
  <li>authority: Azure AD authority</li>
  <li>scope: Scope to send while requesting for token</li>
</ul>

<p>Pass the initialized <code class="language-plaintext highlighter-rouge">DeviceCodeFlowTokenAuth</code> to <code class="language-plaintext highlighter-rouge">RestService</code>. <code class="language-plaintext highlighter-rouge">RestService</code> will use it to set Authorization token before sending request.</p>

<p>In addition to above, change <em>_DEFAULT_TOKEN_CACHE_DIR</em> in <code class="language-plaintext highlighter-rouge">DeviceCodeFlowTokenAuth</code> to any folder of your choosing where you would like the token to be chached. More details below.</p>

<h2 id="how-does-it-work">How does it work</h2>

<p><code class="language-plaintext highlighter-rouge">DeviceCodeFlowTokenAuth</code> accepts configuration which contains client_id, authority and scope to get access token. It first checks if a valid access token or refresh token is present in cache. The in-memory cache is serialized and stored as a file named <em>token</em> in a folder specified by <code class="language-plaintext highlighter-rouge">_DEFAULT_TOKEN_CACHE_DIR</code> variable in home folder (default <em>~/.myapp</em>).</p>

<p>The code will try to read the token from the folder above and populate its <em>TokenCache</em>. If valid access token exist it will use it. Otherwise if a valid refresh token exists it will use it to get a fresh access token and save it in the cache. If neither of them are valid it will initiate <strong>device code flow</strong> to fetch fresh tokens. The <strong>device code flow</strong> will print the code generated to console.</p>

  </div>
  <div class="PageNavigation">
  
  <div class="prevDiv">
    <a class="prev" href="/blog/2020/02/migrating-legacy-application-to-cloud/">&laquo; Modernizing a legacy application</a>
  </div>
  
  
  <div class="nextDiv">
    <a class="next" href="/blog/2020/09/bulk-import-using-sql-spark-connector-p1/">Building large scale data ingestion solutions for Azure SQL using Azure databricks - Part 1 &raquo;</a>
  </div>
  
</div>
<!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="ankitbko/blog"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/blog/2020/08/device-code-flow-using-msal-in-python/" hidden></a>
</article>