<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Skype for Business bot using UCWA</h1><p class="page-description">Chatbot for Skype for business online using UCWA</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2017-02-26T00:00:00-06:00" itemprop="datePublished">
        Feb 26, 2017
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      7 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/blog/categories/#Microsoft Bot Framework">Microsoft Bot Framework</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#LUIS">LUIS</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#Bots">Bots</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#Chat Bots">Chat Bots</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#Conversational Apps">Conversational Apps</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#Skype For Business">Skype For Business</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#UCWA">UCWA</a>
        
      
      </p>
    

    
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>I had recently written a post on how to create a <a href="/2017/01/BusyBot-Sykpe-For-Business-Bot/">Skype for Business chatbot</a>. In that I used Lync 2013 SDK to intercept messages and pass to bot. However I mentioned in my post that there is a better way to achieve the same by using <a href="https://msdn.microsoft.com/en-us/skype/ucwa/unifiedcommunicationswebapi2_0">Unified Communications Web API 2.0</a>(UCWA). Since then I had received a lot of request to write a post on how to do the same. Though I had the code available with me(thanks to Om Shrivastava, my colleague), I did not post it because it was is a very bad shape(you will see). But since there was a lot of demand for it and after discussing with my readers(thank you Dan Williams and Hitesh), I finally got down to do some cleaning up. You can find the source code <a href="https://github.com/ankitbko/ucwa-bot">here</a>. The source code is based on <a href="https://github.com/tamhinsf/ucwa-sfbo-console">Tam Huynh UCWA Sample</a>, a really well written sample which I then made a mess of.</p>

<h3 id="what-is-ucwa-and-why-should-i-care">What is UCWA and why should I care?</h3>
<p>From Microsoft’s own words:</p>

<blockquote>
  <p>Microsoft Unified Communications Web API 2.0 is a REST API that exposes Skype for Business Server 2015 instant messaging (IM) and presence capabilities.</p>
</blockquote>

<p>Ok, so it is set of APIs, but why can’t I just keep on using Lync 2013 SDK for my bot as I created <a href="/2017/01/BusyBot-Sykpe-For-Business-Bot/">previously</a>?.</p>

<p>Well, using Lync 2013 SDK has one major demerit. It requires the bot to run on the system where Skype For Business(SFB)/Lync 2013 is installed and running. That means you are tied down to a machine which would also create problems with scaling. Plus you are dependent upon 4 years old SDK which is no more recommended by Microsoft.</p>

<p>UCWA solves all these problems. Using UCWA, we now no longer need a SFB client running on the system. Bot can be deployed anywhere and scaled independently.</p>

<p>UCWA has a lot of capabilities. However what interests us most is how to <a href="https://msdn.microsoft.com/en-us/skype/ucwa/sendanim">send messages</a> and <a href="https://msdn.microsoft.com/en-us/skype/ucwa/receiveanim">receive messages</a>. Each of these tasks require us to send series of HTTP requests in <em>order</em> to UCWA endpoints. I recommend you read through the above links to understand how it works.</p>

<h3 id="getting-started">Getting Started</h3>
<p>Before even delving into code, you need to set up a lot of things. When developing UCWA applications you need to target either <em>Skype For Business Online</em> or <em>Skype for Business Server(On-Premise)</em>. Both have different setup procedure. I recommend you to read through <a href="https://msdn.microsoft.com/en-us/skype/ucwa/developingapplicationswithucwa">MSDN documentation</a> to understand the differences. In this article and the accompanying code, I would only work with <em>Skype For Business Online</em>. This is primarily because I don’t have an on-premise installation.</p>

<p>The pre-requisite to this is that you must have Office 365 subscription and access to Azure Active Directory to which O365 is linked. Also for setting up you would need to grant permission to our app in Azure Active Directory, which only AD admin can do. Also create two users in Active Directory, one which bot would sign in as and other to test sending message to bot.</p>

<p>Once you have these things ready, the next step is to create an <em>application</em> in Azure Active Directory. I recommend you follow Tam Huynh’s excellent <a href="https://github.com/tamhinsf/ucwa-sfbo-console/blob/master/README.md">guide</a>.</p>

<p>Once you have the app in azure AD properly setup, keep <code class="language-plaintext highlighter-rouge">TenantID</code>, app’s <code class="language-plaintext highlighter-rouge">ClientID</code> and app’s <code class="language-plaintext highlighter-rouge">RedirectURI</code> handy as we would need them in the code.</p>

<h3 id="understanding-the-solution-structure">Understanding the solution structure</h3>

<p>The code itself is just a <em>Console Application</em>. The solution contains 4 folders:</p>

<ul>
  <li>The <strong>Bot</strong> folder contains the <code class="language-plaintext highlighter-rouge">Dialog</code> class and an implementation of <code class="language-plaintext highlighter-rouge">IBotToUser</code>. All these classes are related to Bot Framework. I have used <code class="language-plaintext highlighter-rouge">EchoDialog</code> from the bot framework sample which echoes back the initial message with a count.</li>
  <li><strong>UcwaSfbo</strong> folder mostly contains classes as it is from Tam Huynh’s sample except for <code class="language-plaintext highlighter-rouge">UcwaReciveMessage.cs</code> and <code class="language-plaintext highlighter-rouge">UcwaSendMessage.cs</code>. As name suggests, these two classes are used to receive and send messages to SFB.</li>
  <li><strong>Utilities.cs</strong> contains some some convenience methods.</li>
  <li><strong>Data</strong> folder contains auto generated classes that represents UCWA JSON responses.</li>
</ul>

<hr />

<h4 id="code-smell">Code Smell</h4>

<p><strong>Data</strong> folder is a mess. All these classes were auto-generated based on responses from UCWA APIs. Therefore there are lot of duplicate classes. I tried to clean up some of it but couldn’t get time to see it through. <code class="language-plaintext highlighter-rouge">UcwaReciveMessage.cs</code> and <code class="language-plaintext highlighter-rouge">UcwaSendMessage.cs</code> are also not very well written. It was hastily written as a first attempt to get a PoC on UCWA. Once you get the understanding of what is happening, I would suggest you rewrite them for your own applications.</p>

<h3 id="setting-up-the-code">Setting up the code</h3>
<p>Open <code class="language-plaintext highlighter-rouge">Program.cs</code> and you would see some <code class="language-plaintext highlighter-rouge">static strings</code>. Replace the values of <code class="language-plaintext highlighter-rouge">tenantId</code>, <code class="language-plaintext highlighter-rouge">clientId</code> and <code class="language-plaintext highlighter-rouge">redirectUri</code> to what you copied before. <code class="language-plaintext highlighter-rouge">hardcodedUsername</code> and <code class="language-plaintext highlighter-rouge">hardcodedPassword</code> are credentials for the user that you would want the bot to sign in as. If you don’t want to hardcode the credentials, that is fine too as we will see later. <code class="language-plaintext highlighter-rouge">destinationAddress</code> is not used so you could leave it as it is.</p>

<p>Go to <code class="language-plaintext highlighter-rouge">App.config</code> and enter a valid <code class="language-plaintext highlighter-rouge">MicrosoftAppId</code> and <code class="language-plaintext highlighter-rouge">MicrosoftAppPassword</code> for an existing registration of bot in bot framework portal. It is required as we would be using Bot State Service to store the conversation state.</p>

<p>Once done run the sample and you would be greeted by a console message to choose a login style. <strong>If you are running the project for first time after creating the AD app, choose <code class="language-plaintext highlighter-rouge">dialog</code> option.</strong> This is needed as you would be asked to provide some consent, which requires a web page so <code class="language-plaintext highlighter-rouge">console</code> login doesn’t work. This only needs to be done once. Next time you could just use <code class="language-plaintext highlighter-rouge">console</code> option and bot would sign in using hardcoded credentials which we defined before. If you don’t want to hardcode, your only choice to proceed is through <code class="language-plaintext highlighter-rouge">dialog</code> option.</p>

<p>If the program started successfully you would see json responses in the console. Login to Skype for Business as the other user and send the message to the bot. The bot should echo back what you typed. Great!! Our bot is working as expected.</p>

<h3 id="under-the-hood">Under the hood</h3>

<p>Once the bot signs in using the credentials provided, it polls the UCWA for incoming messages. As mentioned before, you need to send series of requests to UCWA in specific order for this to work. All this is handled in <code class="language-plaintext highlighter-rouge">UcwaReciveMessage.cs</code> class. When you send a message to the bot, the message is actually received in <code class="language-plaintext highlighter-rouge">GetIM_Step03_Events</code> method. Once I get the message I create the <code class="language-plaintext highlighter-rouge">Activity</code> object with minimum information required.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">string</span> <span class="n">SendMessageUrl</span> <span class="p">=</span> <span class="n">item1</span><span class="p">.</span><span class="n">_embedded</span><span class="p">.</span><span class="n">message</span><span class="p">.</span><span class="n">_links</span><span class="p">.</span><span class="n">messaging</span><span class="p">.</span><span class="n">href</span><span class="p">;</span>
<span class="kt">var</span> <span class="n">conversationId</span> <span class="p">=</span> <span class="n">item</span><span class="p">.</span><span class="n">href</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="sc">'/'</span><span class="p">).</span><span class="nf">Last</span><span class="p">();</span>
<span class="kt">var</span> <span class="n">fromId</span> <span class="p">=</span> <span class="n">item1</span><span class="p">.</span><span class="n">_embedded</span><span class="p">.</span><span class="n">message</span><span class="p">.</span><span class="n">_links</span><span class="p">.</span><span class="n">contact</span><span class="p">.</span><span class="n">href</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="sc">'/'</span><span class="p">).</span><span class="nf">Last</span><span class="p">();</span>

<span class="n">Activity</span> <span class="n">activity</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Activity</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">From</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ChannelAccount</span> <span class="p">{</span> <span class="n">Id</span> <span class="p">=</span> <span class="n">fromId</span><span class="p">,</span> <span class="n">Name</span> <span class="p">=</span> <span class="n">fromId</span> <span class="p">},</span>
    <span class="n">Conversation</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ConversationAccount</span> <span class="p">{</span> <span class="n">Id</span> <span class="p">=</span> <span class="n">conversationId</span> <span class="p">},</span>
    <span class="n">Recipient</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ChannelAccount</span> <span class="p">{</span> <span class="n">Id</span> <span class="p">=</span> <span class="s">"Bot"</span> <span class="p">},</span>
    <span class="n">ServiceUrl</span> <span class="p">=</span> <span class="s">"https://skype.botframework.com"</span><span class="p">,</span>
    <span class="n">ChannelId</span> <span class="p">=</span> <span class="s">"skype"</span><span class="p">,</span>
    <span class="n">ChannelData</span> <span class="p">=</span> <span class="n">SendMessageUrl</span>
<span class="p">};</span>

<span class="n">activity</span><span class="p">.</span><span class="n">Text</span> <span class="p">=</span> <span class="n">message</span><span class="p">;</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">conversationId</code> and <code class="language-plaintext highlighter-rouge">fromId</code> are extracted from the JSON response. These are required as the conversation state are stored using these key. <code class="language-plaintext highlighter-rouge">SendMessageUrl</code> is required to reply to user. We store it in the <code class="language-plaintext highlighter-rouge">ChannelData</code> property of <code class="language-plaintext highlighter-rouge">Activity</code>.</p>

<p>Once <code class="language-plaintext highlighter-rouge">activity</code> object is properly initialized, we jump start the bot and pass the <code class="language-plaintext highlighter-rouge">activity</code> object as the incoming message. Instead of starting the bot here, or if you have an existing bot, you could use <a href="https://docs.botframework.com/en-us/restapi/directline3/">Direct Line API</a> to send the message to the bot.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">scope</span> <span class="p">=</span> <span class="n">Microsoft</span><span class="p">.</span><span class="n">Bot</span><span class="p">.</span><span class="n">Builder</span><span class="p">.</span><span class="n">Dialogs</span><span class="p">.</span><span class="n">Conversation</span>
    <span class="p">.</span><span class="n">Container</span><span class="p">.</span><span class="nf">BeginLifetimeScope</span><span class="p">(</span><span class="n">DialogModule</span><span class="p">.</span><span class="n">LifetimeScopeTag</span><span class="p">,</span>
    <span class="n">builder</span> <span class="p">=&gt;</span> <span class="nf">Configure</span><span class="p">(</span><span class="n">builder</span><span class="p">)))</span>
<span class="p">{</span>
    <span class="n">scope</span><span class="p">.</span><span class="n">Resolve</span><span class="p">&lt;</span><span class="n">IMessageActivity</span><span class="p">&gt;</span>
        <span class="p">(</span><span class="n">TypedParameter</span><span class="p">.</span><span class="nf">From</span><span class="p">((</span><span class="n">IMessageActivity</span><span class="p">)</span><span class="n">activity</span><span class="p">));</span>
    <span class="n">DialogModule_MakeRoot</span><span class="p">.</span><span class="nf">Register</span>
        <span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="nf">EchoDialog</span><span class="p">());</span>
    <span class="kt">var</span> <span class="n">postToBot</span> <span class="p">=</span> <span class="n">scope</span><span class="p">.</span><span class="n">Resolve</span><span class="p">&lt;</span><span class="n">IPostToBot</span><span class="p">&gt;();</span>
    <span class="k">await</span> <span class="n">postToBot</span><span class="p">.</span><span class="nf">PostAsync</span><span class="p">(</span><span class="n">activity</span><span class="p">,</span> <span class="n">CancellationToken</span><span class="p">.</span><span class="n">None</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In the <code class="language-plaintext highlighter-rouge">Configure</code> method I register my custom implementation of <code class="language-plaintext highlighter-rouge">IBotToUser</code>.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Configure</span><span class="p">(</span><span class="n">ContainerBuilder</span> <span class="n">builder</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">builder</span><span class="p">.</span><span class="n">RegisterType</span><span class="p">&lt;</span><span class="n">BotToUserLync</span><span class="p">&gt;()</span>
       <span class="p">.</span><span class="n">As</span><span class="p">&lt;</span><span class="n">IBotToUser</span><span class="p">&gt;()</span>
       <span class="p">.</span><span class="nf">InstancePerLifetimeScope</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">BotToUserLync</code> reads the <code class="language-plaintext highlighter-rouge">ChannelData</code> property of the <code class="language-plaintext highlighter-rouge">Activity</code> and calls <code class="language-plaintext highlighter-rouge">SendIM_Step05</code> method of <code class="language-plaintext highlighter-rouge">UcwaSendMessage</code> which sends a request to UCWA to reply to the user.</p>

<h3 id="conclusion">Conclusion</h3>

<p>Using UCWA is easy once you understand how it works. However it is tiring process to write code against it. There are lot of steps to follow in particular order and lack of any SDK makes it more difficult. The present sample is not at all production ready. I would recommend you use this sample to understand what happens inside and implement a better(and cleaner) solution if you are developing it for a live environment.</p>

<p>I hope this article was helpful. If you have any questions, please post a comment below.</p>

  </div>
  <div class="PageNavigation">
  
  <div class="prevDiv">
    <a class="prev" href="/blog/2017/02/cris-with-bot-framework/">&laquo; Integrating CRIS with Microsoft Bot Framework</a>
  </div>
  
  
  <div class="nextDiv">
    <a class="next" href="/blog/2017/03/human-handover-bot/">Transferring chat to a human agent using Microsoft Bot Framework &raquo;</a>
  </div>
  
</div>
<!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="ankitbko/blog"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/blog/2017/02/Sykpe-For-Business-Bot-Using-UCWA/" hidden></a>
</article>