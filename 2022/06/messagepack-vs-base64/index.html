<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Optimizing network footprint using MessagePack</h1><p class="page-description">Measure space and time improvement when using MessagePack instead of JSON to send image over websocket.</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-06-23T00:00:00-05:00" itemprop="datePublished">
        Jun 23, 2022
      </time>• 
          <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span class="p-author h-card" itemprop="name"><a href='https://twitter.com/ankitbko', target='_blank'>Ankit Sinha</a>, <a href='https://github.com/prabdeb', target='_blank'>Prabal Deb</a></span></span>
       • <span class="read-time" title="Estimated read time">
    
    
      2 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/blog/categories/#websocket">websocket</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#python">python</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#performance">performance</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#latency">latency</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#complexity">complexity</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#messagepack">messagepack</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#base64">base64</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#json">json</a>
        
      
      </p>
    

    
		<div class="d-flex flex-wrap flex-justify-start flex-items-center">
			<p class="page-description" style="margin-right: .5rem;">Source Code </p>
			<div class="page-description">
				<div class="px-2">
    <a href="https://github.com/ankitbko/messagepack-websocket" role="button" target="_blank">
        <img class="notebook-badge-image" src="/blog/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

			</div>
		</div>
	
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>The most commonly used technique to send binary data from server to client is to encode it using Base64 and send it as JSON. Base64 encodes each set of <em>three bytes</em> into <em>four bytes</em>. In addition the output will be padded to always be multiple of four. So the final output would be <code class="language-plaintext highlighter-rouge">4/3</code> or 33% larger than the original data. Add overhead of JSON to it and output grows even larger. In most of the scenarios this overhead is negligible and worth paying the cost in return of ease of integration with other applications as most of the languages or frameworks have native support of Base64 encoding.</p>

<p>However in scenarios such as IoT devices, where the bandwidth is limited or there is need of squeezing extra performance, there are other alternatives to Base64 encoding that are more efficient. One such alternative is to use <a href="https://msgpack.org/">MessagePack</a>. It is a binary serialization format which is faster and emits smaller output than using Base64 + JSON.</p>

<h2 id="running-the-sample">Running the sample</h2>

<p>In the provided sample we will send an image from server to UI over a websocket connection using both <em>MessagePack</em> and <em>Base64 encoding + JSON</em> and measure their performance. The browser’s network tab will give us the size of each message. To measure the latency of each message we will use the technique described in my <a href="/blog/2022/06/websocket-latency">Measuring latency of Websocket Messages</a> blog post.</p>

<p>Run the sample by following below steps.</p>

<ol>
  <li>Install Python 3.6+.</li>
  <li>Install the dependencies by running <code class="language-plaintext highlighter-rouge">pip install -r requirements.txt</code>.</li>
  <li>Run the application using <code class="language-plaintext highlighter-rouge">python main.py</code> and open <code class="language-plaintext highlighter-rouge">http://localhost:7001</code> in the browser.</li>
</ol>

<h3 id="using-base64-encoding-and-json">Using Base64 encoding and JSON</h3>
<p>In <code class="language-plaintext highlighter-rouge">frame_handler.py</code> set <code class="language-plaintext highlighter-rouge">USE_MSGPACK</code> to <code class="language-plaintext highlighter-rouge">False</code> and in <code class="language-plaintext highlighter-rouge">index.html</code> set <code class="language-plaintext highlighter-rouge">useMsgPack</code> to <code class="language-plaintext highlighter-rouge">False</code>. This will result in application encoding the image using Base64 and sending JSON over socket connection. Open browser network tab, refresh the page and press <em>Start</em> button. In the network tab, open the <em>websocket</em> connection to view the size of each message. You should see multiple messages being transmitted over the connection which are needed to calculate the latency. The message that contains the image is about 238KB. The browser’s console will log the latency of each message in milliseconds.</p>

<p><img src="/blog/assets/images/posts/messagepack/json-n.png" alt="Json size" />
<img src="/blog/assets/images/posts/messagepack/json-l.png" alt="Json latency" /></p>

<h3 id="using-messagepack">Using MessagePack</h3>
<p>The application is setup to use <em>MessagePack</em> to send the image over websocket. Reverse the changes done in <code class="language-plaintext highlighter-rouge">frame_handler.py</code> and <code class="language-plaintext highlighter-rouge">index.html</code>. Follow the same approach as above to see the size and latency of each message. In the network tab you should see multiple <em>Binary message</em> being received. This is because after using MessagePack we can send the message in binary instead of text. The message that contains image is about 179KB in size.</p>

<p><img src="/blog/assets/images/posts/messagepack/msg-n.png" alt="MessagePack size" />
<img src="/blog/assets/images/posts/messagepack/msg-l.png" alt="MessagePack latency" /></p>

<h2 id="conclusion">Conclusion</h2>

<p>When using MessagePack, messages are <em>25% smaller</em> when compared to its JSON counterpart. Due to this, the latency has been reduced to over <em>40%</em> when compared with JSON message.</p>

<p>The MessagePack encoding is useful where data needs to be delivered quickly or when bandwidth needs to be saved. One such use case is streaming video from camera from server to client in realtime. MessagePack will allow better FPS and smoother video experience.</p>

  </div>
  <div class="PageNavigation">
  
  <div class="prevDiv">
    <a class="prev" href="/blog/2022/06/websocket-latency/">&laquo; Measuring latency of Websocket Messages</a>
  </div>
  
  
  <div class="nextDiv">
    <a class="next" href="/blog/2022/06/vision-on-edge-part-1/">Patterns for Vision on the Edge - Part 1 - Concurrent processing &raquo;</a>
  </div>
  
</div>
<!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="ankitbko/blog"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/blog/2022/06/messagepack-vs-base64/" hidden></a>
</article>