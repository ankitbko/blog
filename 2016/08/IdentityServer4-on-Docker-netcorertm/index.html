<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">IdentityServer4 on Docker (ASP.NET Core 1.0)</h1><p class="page-description">A tutorial on how to host IdentityServer 4 on Docker targeting ASP.NET Core 1.0</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2016-08-18T00:00:00-05:00" itemprop="datePublished">
        Aug 18, 2016
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      4 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/blog/categories/#.net core">.net core</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#docker">docker</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#IdentityServer">IdentityServer</a>
        
      
      </p>
    

    
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>In my previous article I showed how to run Identity Server 4 on Docker targeting ASP.NET Core RC1. In June .NET Core 1.0 and ASP.NET Core 1.0 was released which had some breaking changes. In this post I’ll show what changes are required to run Identity Server 4 targeting ASP.NET Core 1.0 on Docker. I will take up from where we left off on my <a href="https://ankitbko.github.io/2016/03/IdentityServer4-on-Docker/">previous post</a>, so check that out before continuing.</p>

<h3 id="what-changed-in-aspnet-core-10">What changed in ASP.NET Core 1.0?</h3>
<p>There are some breaking changes in ASP.NET Core 1.0. In this guide I only focus on changes needed to run IdSrv4 on docker. For complete detail on how to migrate an application to ASP.NET Core 1.0 from RC1, check out <a href="https://docs.asp.net/en/latest/migration/rc1-to-rtm.html">official guide</a>.</p>

<ul>
  <li>The first major change you’ll notice is that <code class="language-plaintext highlighter-rouge">dnx</code> is gone instead .NET Core 1.0 features new <code class="language-plaintext highlighter-rouge">dotnet</code> CLI. This change would affect how we build and publish our application and Dockerfile.</li>
  <li>Another change is that <code class="language-plaintext highlighter-rouge">dnx commands</code> are gone. This directly affects how we host our applications.</li>
  <li>There are also small changes in <code class="language-plaintext highlighter-rouge">project.json</code> and <code class="language-plaintext highlighter-rouge">Program.cs</code> which are not of great interest to us for this guide.</li>
  <li>Apart from these, Microsoft has also released a new docker base image for .NET Core 1.0 applications called <code class="language-plaintext highlighter-rouge">microsoft/dotnet:1.0.0-core</code>. We will use this to create our docker image.</li>
</ul>

<p>I have changed my sample application to target ASP.NET Core 1.0 and made all the above changes to it. You can find the source code <a href="https://github.com/ankitbko/IdentityServer4.DockerSample/tree/netcore1.0">here</a>.</p>

<h3 id="changes-to-the-sample-application">Changes to the sample application</h3>
<p>There are few changes I would like to point out before we continue.</p>

<ul>
  <li>I have updated all the projects to target ASP.NET Core 1.0. All the projects are fork of IdentityServer4 repository with some minor changes.</li>
  <li><code class="language-plaintext highlighter-rouge">dnx web</code> no longer exist. Instead we self-host the application using <code class="language-plaintext highlighter-rouge">dotnet</code> CLI. To configure port, we use environment variable ASPNETCORE_URLS present in Dockerfile.</li>
  <li>I have included Dockerfile in each of the project directory. The Dockerfile will automatically be copied when we publish our applications.</li>
  <li>There are changes in the ports in which applications are hosted -
    <ul>
      <li>Identity Server is hosted on port 1941</li>
      <li>Javascript Client remains hosted on 7017</li>
      <li>Sample Api is now hosted on 3721</li>
    </ul>
  </li>
</ul>

<h3 id="lets-get-started">Let’s get started</h3>

<p>Again before continuing, I recommend you read though my <a href="https://ankitbko.github.io/2016/03/IdentityServer4-on-Docker/">previous article</a>. It would set up the context and fill in the gaps present in this post.
Done! Good!</p>

<p>The first two steps remain same, download and install Docker Toolbox and create a Docker VM. If you have Windows 10 Pro or Enterprise, you may also give try to new Docker for Windows which has recently moved out of beta.</p>

<h4 id="change-urls-in-the-code">Change URLs in the code</h4>

<p>You will have to change the URLs in your code to point to the new VM URL in the following places:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">IdSrvHost\Configuration\Clients.cs</code>: Change all the URL here to point to the VM. Leave the port as 7017.</li>
  <li><code class="language-plaintext highlighter-rouge">SampleApi\Startup.cs</code>: Change the URL in <code class="language-plaintext highlighter-rouge">app.UseIdentityServerAuthentication</code>. Leave the port as 1941.</li>
  <li><code class="language-plaintext highlighter-rouge">JavaScript Oidc\wwwroot\index.html</code>: There are two places in this file where URL needs to be changed. Leave the ports as it is in each place.</li>
</ul>

<h4 id="publish-the-projects">Publish the projects</h4>

<p>Go to each project folder and run <code class="language-plaintext highlighter-rouge">dotnet publish</code> to publish in your desired folder.</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nf">dotnet</span><span class="w"> </span><span class="nx">publish</span><span class="w"> </span><span class="nt">-r</span><span class="w"> </span><span class="nx">debian.8-x64</span><span class="w"> </span><span class="nt">-o</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">Path</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">output</span><span class="w"> </span><span class="nx">directory</span><span class="err">&gt;</span></code></pre></figure>

<h4 id="changes-to-dockerfile">Changes to Dockerfile</h4>

<p>I have already added Dockerfile to each of the project which should automatically get copied when you published each application in the previous step. Below I’ll explain the new Dockerfile.</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">FROM microsoft/dotnet:1.0.0-core

<span class="c"># Copy the app</span>
COPY <span class="nb">.</span> /app

<span class="c"># Set the Working Directory</span>
WORKDIR /app

<span class="c"># Configure the listening port to 80</span>
ENV ASPNETCORE_URLS http://<span class="k">*</span>:80

<span class="c"># Start the app</span>
ENTRYPOINT dotnet &lt;DLLNAME&gt;</code></pre></figure>

<ul>
  <li><code class="language-plaintext highlighter-rouge">FROM microsoft/dotnet:1.0.0-core</code>: We use the newer dotnet base image from Microsoft. Docker will run all the following commands on top of this base image.</li>
  <li><code class="language-plaintext highlighter-rouge">COPY . /app</code>: Copy the current folder to <code class="language-plaintext highlighter-rouge">/app</code> folder in container.</li>
  <li><code class="language-plaintext highlighter-rouge">WORKDIR /app</code>: Set the WORKDIR to /app folder. We now no longer have approot folder. Instead all the DLL lies here. This sets the working directory in container and executes remaining command from this directory.</li>
  <li><code class="language-plaintext highlighter-rouge">ENV ASPNETCORE_URLS http://*:80</code>: This adds an environment variable <code class="language-plaintext highlighter-rouge">ASPNETCORE_URLS</code> which directs kestrel to listen to port 80.</li>
  <li><code class="language-plaintext highlighter-rouge">ENTRYPOINT dotnet &lt;DLLNAME&gt;</code>: This instruction will host the application specified in <DLLNAME>. This is how we host application in `dotnet` CLI.</DLLNAME></li>
</ul>

<h4 id="build-image">Build Image</h4>

<p>This step remains as it was. Just run <code class="language-plaintext highlighter-rouge">docker build -t &lt;tag&gt; .</code> command in each output directory to create images.</p>

<h4 id="create-the-container">Create the container</h4>

<p>There are minor changes in the port mapping. Now kestrel in each container will listen on port 80, to which we bind host port as specified below</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nf">docker</span><span class="w"> </span><span class="nx">run</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="nt">-p</span><span class="w"> </span><span class="nx">1941:80</span><span class="w"> </span><span class="nt">--name</span><span class="w"> </span><span class="nx">idsrv-host</span><span class="w"> </span><span class="nx">idsrvhost</span><span class="w">
</span><span class="nf">docker</span><span class="w"> </span><span class="nx">run</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="nt">-p</span><span class="w"> </span><span class="nx">7017:80</span><span class="w"> </span><span class="nt">--name</span><span class="w"> </span><span class="nx">client</span><span class="w"> </span><span class="nx">jsclient</span><span class="w">
</span><span class="nf">docker</span><span class="w"> </span><span class="nx">run</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="nt">-p</span><span class="w"> </span><span class="nx">3721:80</span><span class="w"> </span><span class="nt">--name</span><span class="w"> </span><span class="nx">api</span><span class="w"> </span><span class="nx">sampleapi</span></code></pre></figure>

<ul>
  <li><code class="language-plaintext highlighter-rouge">docker run</code>: Creates and start a new container.</li>
  <li><code class="language-plaintext highlighter-rouge">-d</code>: Run the container in background.</li>
  <li><code class="language-plaintext highlighter-rouge">-p &lt;host&gt;:&lt;container&gt;</code>: Map the specified port of host to the port container.</li>
  <li><code class="language-plaintext highlighter-rouge">--name &lt;ContainerName&gt;</code>: Creates the container with the specified name.</li>
  <li>The last parameter is the name of the image from which to create the container.</li>
</ul>

<h4 id="thats-it">That’s it.</h4>

<p>These are all the changes required to run IdSrv 4 on docker targeting ASP.NET Core 1.0. Open the browser and go to the URL:PORT to view each of the site.</p>

<p>Leave a comment if you have any feedbacks.</p>

  </div>
  <div class="PageNavigation">
  
  <div class="prevDiv">
    <a class="prev" href="/blog/2016/03/IdentityServer4-on-Docker/">&laquo; IdentityServer4 on Docker</a>
  </div>
  
  
  <div class="nextDiv">
    <a class="next" href="/blog/2016/08/ChatBot-using-Microsoft-Bot-Framework-Part-1/">Chatbot using Microsoft Bot Framework - Part 1 &raquo;</a>
  </div>
  
</div>
<!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="ankitbko/blog"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/blog/2016/08/IdentityServer4-on-Docker-netcorertm/" hidden></a>
</article>