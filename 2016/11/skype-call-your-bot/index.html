<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Skype Call your bot - Microsoft Bot Framework with Bing Speech | F5 - Squashing Bugs</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Skype Call your bot - Microsoft Bot Framework with Bing Speech" />
<meta name="author" content="Ankit Sinha" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Skype Call your bot by integrating Microsoft Bot Framework with Bing Speech" />
<meta property="og:description" content="Skype Call your bot by integrating Microsoft Bot Framework with Bing Speech" />
<link rel="canonical" href="https://ankitbko.github.io/blog/2016/11/skype-call-your-bot/" />
<meta property="og:url" content="https://ankitbko.github.io/blog/2016/11/skype-call-your-bot/" />
<meta property="og:site_name" content="F5 - Squashing Bugs" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2016-11-09T00:00:00-06:00" />
<script type="application/ld+json">
{"datePublished":"2016-11-09T00:00:00-06:00","url":"https://ankitbko.github.io/blog/2016/11/skype-call-your-bot/","@type":"BlogPosting","headline":"Skype Call your bot - Microsoft Bot Framework with Bing Speech","dateModified":"2016-11-09T00:00:00-06:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://ankitbko.github.io/blog/2016/11/skype-call-your-bot/"},"author":{"@type":"Person","name":"Ankit Sinha"},"description":"Skype Call your bot by integrating Microsoft Bot Framework with Bing Speech","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/blog/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://ankitbko.github.io/blog/feed.xml" title="F5 - Squashing Bugs" /><!-- the google_analytics_id gets auto inserted from the config file -->



<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-75679348-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-75679348-1');
</script>


<link rel="shortcut icon" type="image/x-icon" href="/blog/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/blog/">F5 - Squashing Bugs</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/blog/about/">About Me</a><a class="page-link" href="/blog/search/">Search</a><a class="page-link" href="/blog/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Skype Call your bot - Microsoft Bot Framework with Bing Speech</h1><p class="page-description">Skype Call your bot by integrating Microsoft Bot Framework with Bing Speech</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2016-11-09T00:00:00-06:00" itemprop="datePublished">
        Nov 9, 2016
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      18 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/blog/categories/#Microsoft Bot Framework">Microsoft Bot Framework</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#LUIS">LUIS</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#Bots">Bots</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#Chat Bots">Chat Bots</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#Conversational Apps">Conversational Apps</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#Skype">Skype</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#Bing Speech">Bing Speech</a>
        
      
      </p>
    

    
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>So over this past weekend, I was dead bored when I got this idea of calling a bot from Skype. Skype bot calling feature does exist(preview) but the samples which are available are only for simple IVR bot. So I thought why not integrate it with Bot Builder SDK, so that same bot can text and answer call at same time. So the basic idea is that the bot should follow the same <em>flow</em> irrespective whether the user texts or calls. Great idea to past time, after some initial trouble, I did manage to get it done(not neatly though). So why not write a blog about it.
Source code is available over my <a href="https://github.com/ankitbko/RentACarBot">github repo</a>.</p>

<blockquote>
  <p>I developed this sample over weekend just to find out whether it could be done or not. It is not a very cleanly written sample and there is a design flaw due to which the bot cannot be scaled out. I will address this design issue and also explain how we can make it scalable. Nonetheless, I decided to write down this blog because it provides a nice insight into Skype Calling Bot and also how to intercept the responses from Bot by implementing <code class="language-plaintext highlighter-rouge">IBotToUser</code> interface.</p>
</blockquote>

<p>For this <em>fun</em> project, we will use the Bot Builder Calling SDK which is now part of Bot Framework, to make a call to our bot. Once we get the audio stream of the caller, we will use <a href="https://www.microsoft.com/cognitive-services/en-us/speech-api">Bing Speech API</a> for Speech-to-Text conversion. After we receive the text, we will just pass it to our bot and our bot will behave in the same way as it does for text input. The trick here is to not let our bot reply back to user through bot connector, but to intercept the reply messages and pass it onto Skype Calling APIs which manages Text-to-Speech conversion and would <em>speak</em> back to the user. The plan is to utilize feature rich Bot Builder SDK to build our bot and plugin the voice calling functionality on top of it, without having to modify any of the bot logic.</p>

<p>Fair Warning: This is going to be a long post. Before getting into details, I will give a brief overview of Bot Builder Calling SDK and Bing Speech SDK.</p>

<h3 id="bot-builder-calling-sdk">Bot Builder Calling SDK</h3>

<p>Bot Builder Calling SDK is just a nice client package to call <a href="https://docs.botframework.com/en-us/skype/calling">Skype Calling APIs</a>. I recommend you read through the API documentation to understand how calling works through Skype. I will just explain it briefly here.</p>

<p>When a call arrive to Skype Bot Platform, it would notify our bot by calling our bot’s HTTPS endpoint. Once we receive this notification, we(our bot) can reply back by providing a list of actions called <strong>workflow</strong> to execute. So for the initial call notification, we can either reply back by <code class="language-plaintext highlighter-rouge">Answer</code> or <code class="language-plaintext highlighter-rouge">Reject</code> action. The Skype Bot Platform will then execute the workflow and return us the result of last action executed. The SDK will raise an appropriate <code class="language-plaintext highlighter-rouge">Event</code> which we can subscribe to and handle the action outcome in our code. For example, on initial call notification, sdk will raise <code class="language-plaintext highlighter-rouge">OnIncomingCallReceived</code> event. On each event, we have opportunity to send another workflow to the user. In fact it is mandatory to return list of actions otherwise the sdk will throw an error and the call would get disconnected.
The below image, which I shamelessly copied from official documentation, explains how Skype calling works.</p>

<p><img src="/blog/assets/images/posts/skypecall/flow.png" alt="Skype Call Flow" /></p>

<h3 id="bing-speech-api">Bing Speech API</h3>

<p>We will use <a href="https://www.microsoft.com/cognitive-services/en-us/speech-api">Bing Speech API</a> for Speech-to-Text(STT) conversion. Microsoft team has released a thin C# client library for STT conversion using Bing Speech API. The samples are available on <a href="https://github.com/Microsoft/Cognitive-Speech-STT-Windows">github</a> and the library is available over nuget. For some reason they have different libraries for x64 and x86. Make sure you use the correct one depending upon your system.</p>

<p>The first thing to do is get a Speech API subscription key (free) by signing up for <a href="https://www.microsoft.com/cognitive-services/en-US/subscriptions">Cognitive Services</a>. The STT sdk also works on event based model. In simple terms, the audio stream is sent to Speech API, which then returns the recognized text which is available in the argument <code class="language-plaintext highlighter-rouge">OnResponseReceived</code> event which is raised. The Speech API also returns partially converted text, but in our case we ignore them.</p>

<h3 id="putting-it-all-together">Putting it all together</h3>

<p>But before that, we need to get develop a bot which works text inputs. I have gone ahead and created a very simple bot using FormFlow which allows user to rent a car. LUIS is used for text classification which returns the intent as <code class="language-plaintext highlighter-rouge">Rent</code> and entities such as <code class="language-plaintext highlighter-rouge">PickLocation</code> and <code class="language-plaintext highlighter-rouge">Pickup Date and Time</code>. Following which I just pass the entities to the FormFlow which takes care of asking appropriate questions and filling out rest of the form. Simple.</p>

<p><img src="/blog/assets/images/posts/skypecall/rentcar.png" alt="Skype Call Flow" /></p>

<p>To integrate Skype call, there are few complication -</p>

<ul>
  <li>There are 2 layers of event based models which needs to be wired together - Skype Calling SDK and Bing Speech SDK.</li>
  <li>The STT output needs to be supplied to the Bot Builder in <em>correct</em> format. Our bot expects an <code class="language-plaintext highlighter-rouge">IMessageActivity</code> instance with properly filled in IDs such as Conversation ID, Channel ID etc so that it can fetch correct state from State Service.</li>
  <li>The response from the bot needs to be intercepted and somehow returned back to event based model of Skype SDK.</li>
</ul>

<p>We will address each of them one by one.</p>

<p>To start with we create a project from <a href="https://aka.ms/bf-builder-calling">Calling Bot Template</a>. The template creates a very basic IVR bot with a <code class="language-plaintext highlighter-rouge">CallingController</code> which receives the request from Skype Bot Platform and a <code class="language-plaintext highlighter-rouge">SimpleCallingBot</code> class which derives from <code class="language-plaintext highlighter-rouge">ICallingBot</code> which handles all the events which are raised by the Calling Bot SDK. The template also have a <code class="language-plaintext highlighter-rouge">MessageController</code> with default bot implementation.</p>

<p>Next create a new class <code class="language-plaintext highlighter-rouge">RentCarCallingBot</code> and derive it with <code class="language-plaintext highlighter-rouge">ICallingBot</code>. I have used <code class="language-plaintext highlighter-rouge">SimpleCallingBot</code> as a reference therefore you will see basic structure and few methods are same. In the constructor we subscribe to the events which will be raised when a workflow is completed.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="nf">RentCarCallingBot</span><span class="p">(</span><span class="n">ICallingBotService</span> <span class="n">callingBotService</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">callingBotService</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">callingBotService</span><span class="p">));</span>

    <span class="k">this</span><span class="p">.</span><span class="n">CallingBotService</span> <span class="p">=</span> <span class="n">callingBotService</span><span class="p">;</span>

    <span class="n">CallingBotService</span><span class="p">.</span><span class="n">OnIncomingCallReceived</span> <span class="p">+=</span> <span class="n">OnIncomingCallReceived</span><span class="p">;</span>
    <span class="n">CallingBotService</span><span class="p">.</span><span class="n">OnPlayPromptCompleted</span> <span class="p">+=</span> <span class="n">OnPlayPromptCompleted</span><span class="p">;</span>
    <span class="n">CallingBotService</span><span class="p">.</span><span class="n">OnRecordCompleted</span> <span class="p">+=</span> <span class="n">OnRecordCompleted</span><span class="p">;</span>
    <span class="n">CallingBotService</span><span class="p">.</span><span class="n">OnHangupCompleted</span> <span class="p">+=</span> <span class="n">OnHangupCompleted</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We subscribe to only 4 events -</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">OnIncomingCallReceived</code>: Is fired when a call arrives at Skype Bot Platform. This is the same event which I explained earlier. Here we can either accept or reject the call.</li>
  <li><code class="language-plaintext highlighter-rouge">OnPlayPromptCompleted</code>: Is fired when <code class="language-plaintext highlighter-rouge">PlayPrompt</code> action is completed. <code class="language-plaintext highlighter-rouge">PlayPrompt</code> action performs Text-to-Speech(TTS) conversion and plays back the supplied text to the caller. Once the playback is complete and if it is the last action in the workflow, then this event is raised.</li>
  <li><code class="language-plaintext highlighter-rouge">OnRecordCompleted</code>: Similar to above, this event is raised when <code class="language-plaintext highlighter-rouge">Record</code> action completes. <code class="language-plaintext highlighter-rouge">Record</code> action allows us to record the caller’s voice and gives us an audio stream. This is the primary way to receive the audio of caller.</li>
  <li><code class="language-plaintext highlighter-rouge">OnHangupCompleted</code>: As name suggests, is raised when we hangup.</li>
</ul>

<h4 id="onincomingcallreceived">OnIncomingCallReceived</h4>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="n">Task</span> <span class="nf">OnIncomingCallReceived</span><span class="p">(</span><span class="n">IncomingCallEvent</span> <span class="n">incomingCallEvent</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">id</span> <span class="p">=</span> <span class="n">Guid</span><span class="p">.</span><span class="nf">NewGuid</span><span class="p">().</span><span class="nf">ToString</span><span class="p">();</span>
    <span class="n">incomingCallEvent</span><span class="p">.</span><span class="n">ResultingWorkflow</span><span class="p">.</span><span class="n">Actions</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">ActionBase</span><span class="p">&gt;</span>
        <span class="p">{</span>
            <span class="k">new</span> <span class="n">Answer</span> <span class="p">{</span> <span class="n">OperationId</span> <span class="p">=</span> <span class="n">id</span> <span class="p">},</span>
            <span class="nf">GetRecordForText</span><span class="p">(</span><span class="s">"Welcome! How can I help you?"</span><span class="p">)</span>
        <span class="p">};</span>
    <span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="nf">FromResult</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Upon receiving a call, we get an <code class="language-plaintext highlighter-rouge">IncomingCallEvent</code> object as argument. To this, we can add next steps of actions to be executed in the workflow. We add 2 events to the workflow - <em>Answer</em> and <em>Record</em>. We first answer the call and then start a <em>Record</em> action to get the caller’s input. Skype will start recording after speaking welcome message. The recorded stream will be available to us in <code class="language-plaintext highlighter-rouge">OnRecordCompleted</code> event.
A thing to note is that we must specify an <em>OperationId</em> to each action. It is used to correlate the outcome of the event.</p>

<h4 id="onrecordcompleted">OnRecordCompleted</h4>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">OnRecordCompleted</span><span class="p">(</span><span class="n">RecordOutcomeEvent</span> <span class="n">recordOutcomeEvent</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">recordOutcomeEvent</span><span class="p">.</span><span class="n">RecordOutcome</span><span class="p">.</span><span class="n">Outcome</span> <span class="p">==</span> <span class="n">Outcome</span><span class="p">.</span><span class="n">Success</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">record</span> <span class="p">=</span> <span class="k">await</span> <span class="n">recordOutcomeEvent</span><span class="p">.</span><span class="n">RecordedContent</span><span class="p">;</span>
        <span class="n">BingSpeech</span> <span class="n">bs</span> <span class="p">=</span>
            <span class="k">new</span> <span class="nf">BingSpeech</span><span class="p">(</span><span class="n">recordOutcomeEvent</span><span class="p">.</span><span class="n">ConversationResult</span><span class="p">,</span> <span class="n">t</span> <span class="p">=&gt;</span> <span class="n">response</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">s</span> <span class="p">=&gt;</span> <span class="n">sttFailed</span> <span class="p">=</span> <span class="n">s</span><span class="p">);</span>
        <span class="n">bs</span><span class="p">.</span><span class="nf">CreateDataRecoClient</span><span class="p">();</span>
        <span class="n">bs</span><span class="p">.</span><span class="nf">SendAudioHelper</span><span class="p">(</span><span class="n">record</span><span class="p">);</span>
        <span class="n">recordOutcomeEvent</span><span class="p">.</span><span class="n">ResultingWorkflow</span><span class="p">.</span><span class="n">Actions</span> <span class="p">=</span>
            <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">ActionBase</span><span class="p">&gt;</span>
            <span class="p">{</span>
                <span class="nf">GetSilencePrompt</span><span class="p">()</span>
            <span class="p">};</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">silenceTimes</span> <span class="p">&gt;</span> <span class="m">1</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">recordOutcomeEvent</span><span class="p">.</span><span class="n">ResultingWorkflow</span><span class="p">.</span><span class="n">Actions</span> <span class="p">=</span>
                <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">ActionBase</span><span class="p">&gt;</span>
                <span class="p">{</span>
                    <span class="nf">GetPromptForText</span><span class="p">(</span><span class="s">"Thank you for calling"</span><span class="p">),</span>
                    <span class="k">new</span> <span class="nf">Hangup</span><span class="p">()</span>
                    <span class="p">{</span>
                        <span class="n">OperationId</span> <span class="p">=</span> <span class="n">Guid</span><span class="p">.</span><span class="nf">NewGuid</span><span class="p">().</span><span class="nf">ToString</span><span class="p">()</span>
                    <span class="p">}</span>
                <span class="p">};</span>
            <span class="n">recordOutcomeEvent</span><span class="p">.</span><span class="n">ResultingWorkflow</span><span class="p">.</span><span class="n">Links</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
            <span class="n">silenceTimes</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">silenceTimes</span><span class="p">++;</span>
            <span class="n">recordOutcomeEvent</span><span class="p">.</span><span class="n">ResultingWorkflow</span><span class="p">.</span><span class="n">Actions</span> <span class="p">=</span>
                <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">ActionBase</span><span class="p">&gt;</span>
                <span class="p">{</span>
                    <span class="nf">GetRecordForText</span><span class="p">(</span><span class="s">"I didn't catch that, would you kinly repeat?"</span><span class="p">)</span>
                <span class="p">};</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>There are three sections in this method. The first if block is executed when we have successfully recorded the voice of the caller. We get the recorded content and pass it to <code class="language-plaintext highlighter-rouge">BingSpeech</code> class. It accepts 3 arguments in constructor, the first being the <code class="language-plaintext highlighter-rouge">ConversationResult</code>, the second and third being 2 delegates. The first delegate is used add a string to <code class="language-plaintext highlighter-rouge">response</code> property which is a <code class="language-plaintext highlighter-rouge">List&lt;string&gt;</code>. The <code class="language-plaintext highlighter-rouge">response</code> list maintains the list of messages which bot will send to the caller. The second delegate sets a flag if the STT conversion failed. In short this class calls the Bing Speech API and upon receiving the STT output, it goes ahead and passes it to our bot.
Then we go ahead and add a <code class="language-plaintext highlighter-rouge">PlayPrompt</code> action which just keeps silence for specified period of time. This is required as we do not have result from bot immediately as we will see later.</p>

<p>If we do not receive a successful recoding, we give the caller a chance to speak again once more. If the recording fails again, we disconnect the call gracefully. The <code class="language-plaintext highlighter-rouge">silenceTimes</code> counter is used for this purpose.</p>

<h4 id="onplaypromptcompleted">OnPlayPromptCompleted</h4>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="n">Task</span> <span class="nf">OnPlayPromptCompleted</span><span class="p">(</span><span class="n">PlayPromptOutcomeEvent</span> <span class="n">playPromptOutcomeEvent</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">Count</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">silenceTimes</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
        <span class="kt">var</span> <span class="n">actionList</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">ActionBase</span><span class="p">&gt;();</span>
        <span class="n">actionList</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nf">GetPromptForText</span><span class="p">(</span><span class="n">response</span><span class="p">));</span>
        <span class="n">actionList</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nf">GetRecordForText</span><span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">));</span>
        <span class="n">playPromptOutcomeEvent</span><span class="p">.</span><span class="n">ResultingWorkflow</span><span class="p">.</span><span class="n">Actions</span> <span class="p">=</span> <span class="n">actionList</span><span class="p">;</span>
        <span class="n">response</span><span class="p">.</span><span class="nf">Clear</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sttFailed</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">playPromptOutcomeEvent</span><span class="p">.</span><span class="n">ResultingWorkflow</span><span class="p">.</span><span class="n">Actions</span> <span class="p">=</span>
                <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">ActionBase</span><span class="p">&gt;</span>
                <span class="p">{</span>
                    <span class="nf">GetRecordForText</span><span class="p">(</span><span class="s">"I didn't catch that, would you kindly repeat?"</span><span class="p">)</span>
                <span class="p">};</span>
            <span class="n">sttFailed</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
            <span class="n">silenceTimes</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">silenceTimes</span> <span class="p">&gt;</span> <span class="m">2</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">playPromptOutcomeEvent</span><span class="p">.</span><span class="n">ResultingWorkflow</span><span class="p">.</span><span class="n">Actions</span> <span class="p">=</span>
                <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">ActionBase</span><span class="p">&gt;</span>
                <span class="p">{</span>
                    <span class="nf">GetPromptForText</span><span class="p">(</span><span class="s">"Something went wrong. Call again later."</span><span class="p">),</span>
                    <span class="k">new</span> <span class="nf">Hangup</span><span class="p">()</span>
                    <span class="p">{</span>
                        <span class="n">OperationId</span> <span class="p">=</span> <span class="n">Guid</span><span class="p">.</span><span class="nf">NewGuid</span><span class="p">().</span><span class="nf">ToString</span><span class="p">()</span>
                    <span class="p">}</span>
                <span class="p">};</span>
            <span class="n">playPromptOutcomeEvent</span><span class="p">.</span><span class="n">ResultingWorkflow</span><span class="p">.</span><span class="n">Links</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
            <span class="n">silenceTimes</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">silenceTimes</span><span class="p">++;</span>
            <span class="n">playPromptOutcomeEvent</span><span class="p">.</span><span class="n">ResultingWorkflow</span><span class="p">.</span><span class="n">Actions</span> <span class="p">=</span>
                <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">ActionBase</span><span class="p">&gt;</span>
                <span class="p">{</span>
                    <span class="nf">GetSilencePrompt</span><span class="p">(</span><span class="m">2000</span><span class="p">)</span>
                <span class="p">};</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="n">CompletedTask</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The first time this event is raised is when we have recorded the user’s input and have passed it to the <code class="language-plaintext highlighter-rouge">BingSpeech</code> class. At this point of time, we may or may not have any output from the bot itself. If there are any output(reply) from the bot, it will be added to <code class="language-plaintext highlighter-rouge">response</code> list. The <code class="language-plaintext highlighter-rouge">response</code> field contains the <code class="language-plaintext highlighter-rouge">List&lt;string&gt;</code> which are returned by bot to the user. If <code class="language-plaintext highlighter-rouge">response</code> is not empty, we get the <code class="language-plaintext highlighter-rouge">PlayPrompt</code> Action for the responses and add it to the workflow. We add a <code class="language-plaintext highlighter-rouge">Record</code> action after <code class="language-plaintext highlighter-rouge">PlayPrompt</code> to capture the next input from caller.
In case the <code class="language-plaintext highlighter-rouge">response</code> is empty, it may mean one of the following two things, either the STT conversion failed or the processing of earlier input is yet not completed by the bot. If the STT conversion failed, we play a prompt to user and ask him to repeat and start the recording again. If the bot has not yet processed the previous input, then we start another <em>silence</em> prompt. We maintain a counter for how many times did we end up waiting for bot to complete processing, if it increases a threshold, we gracefully hangup.</p>

<h4 id="onhangupcompleted">OnHangupCompleted</h4>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="n">Task</span> <span class="nf">OnHangupCompleted</span><span class="p">(</span><span class="n">HangupOutcomeEvent</span> <span class="n">hangupOutcomeEvent</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">hangupOutcomeEvent</span><span class="p">.</span><span class="n">ResultingWorkflow</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="nf">FromResult</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Self-explanatory. Just set the workflow to null and return.</p>

<hr />

<h3 id="intercepting-bot-response">Intercepting Bot response</h3>

<p>Microsoft Bot Framework does not return the response/reply in-line to the HTTP request. Instead it sends a separate HTTP request to Bot Connector with the reply message. We can intercept this flow by implementing <code class="language-plaintext highlighter-rouge">IBotToUser</code> interface. The default implementation which sends the message to Bot Connector is called <code class="language-plaintext highlighter-rouge">AlwaysSendDirect_BotToUser</code>. We will create a class <code class="language-plaintext highlighter-rouge">BotToUserSpeech</code> and derive this interface.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="nf">BotToUserSpeech</span><span class="p">(</span><span class="n">IMessageActivity</span> <span class="n">toBot</span><span class="p">,</span> <span class="n">Action</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">_callback</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">SetField</span><span class="p">.</span><span class="nf">NotNull</span><span class="p">(</span><span class="k">out</span> <span class="k">this</span><span class="p">.</span><span class="n">toBot</span><span class="p">,</span> <span class="k">nameof</span><span class="p">(</span><span class="n">toBot</span><span class="p">),</span> <span class="n">toBot</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="n">_callback</span> <span class="p">=</span> <span class="n">_callback</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">public</span> <span class="n">IMessageActivity</span> <span class="nf">MakeMessage</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">toBot</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">PostAsync</span><span class="p">(</span><span class="n">IMessageActivity</span> <span class="n">message</span><span class="p">,</span> <span class="n">CancellationToken</span> <span class="n">cancellationToken</span> <span class="p">=</span> <span class="k">default</span><span class="p">(</span><span class="n">CancellationToken</span><span class="p">))</span>
<span class="p">{</span>
    <span class="nf">_callback</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="n">Text</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="n">Attachments</span><span class="p">?.</span><span class="n">Count</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
        <span class="nf">_callback</span><span class="p">(</span><span class="nf">ButtonsToText</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="n">Attachments</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The constructor takes two parameters, the first being <code class="language-plaintext highlighter-rouge">IMessageActivity</code> and the second being a delegate to return the response to. This is the same delegate which was passed in <code class="language-plaintext highlighter-rouge">BingSpeech</code> class constructor in <code class="language-plaintext highlighter-rouge">OnRecordCompleted</code> event. The delegate just adds the string to <code class="language-plaintext highlighter-rouge">response</code> field. We need to implement just two method to MakeMessage and PostAsync. In MakeMessage we just return back the <code class="language-plaintext highlighter-rouge">IMessageActivity</code> object that we received from constructor. In PostAsync, we call the _callback delegate with the message text field. If the message has any attachment, we convert the buttons and cards in the attachment to plain string which is then passed to _callback. This ensures that buttons which are displayed to user normally in chat windows, gets converted to simple text so that the caller has all the options.</p>

<p>Once we have this class ready, we just need to wire it up in the dependency container which we do in <code class="language-plaintext highlighter-rouge">BingSpeech</code> class.</p>

<h3 id="bingspeech">BingSpeech</h3>

<p>This class performs three tasks (talk about SRP!!!). First it receives the audio stream and sends it in chunks to Bing Speech API. Second it receives the event which is raised once the Bing Speech completes the STT conversion. Third it takes the STT output, and sends it to our RentACar bot. For this step it must setup the required dependencies and get instances through container to pass the message in <em>correct</em> format. Let’s step through each of them one by one. But before that, put the Bing Speech API subscription key in <code class="language-plaintext highlighter-rouge">SubscriptionKey</code> property.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">string</span> <span class="n">SubscriptionKey</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span> <span class="p">=</span> <span class="s">"Bing Speech subscription key"</span><span class="p">;</span>
</code></pre></div></div>

<h4 id="perform-speech-to-text">Perform Speech-To-Text</h4>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">void</span> <span class="nf">CreateDataRecoClient</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="n">dataClient</span> <span class="p">=</span> <span class="n">SpeechRecognitionServiceFactory</span><span class="p">.</span><span class="nf">CreateDataClient</span><span class="p">(</span>
        <span class="n">SpeechRecognitionMode</span><span class="p">.</span><span class="n">ShortPhrase</span><span class="p">,</span>
        <span class="k">this</span><span class="p">.</span><span class="n">DefaultLocale</span><span class="p">,</span>
        <span class="k">this</span><span class="p">.</span><span class="n">SubscriptionKey</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="n">dataClient</span><span class="p">.</span><span class="n">OnResponseReceived</span> <span class="p">+=</span> <span class="k">this</span><span class="p">.</span><span class="n">OnDataShortPhraseResponseReceivedHandler</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>First we ask <code class="language-plaintext highlighter-rouge">SpeechRecognitionServiceFactory</code> to give us a <code class="language-plaintext highlighter-rouge">DataClient</code> instance. <code class="language-plaintext highlighter-rouge">SpeechRecognitionServiceFactory</code> can give us 4 types of clients -</p>

<ul>
  <li>MicrophoneClient: Used to get audio stream by using device’s microphone and then perform STT conversion.</li>
  <li>DataClient: No microphone support. You can use it to pass audio from <code class="language-plaintext highlighter-rouge">Stream</code>.</li>
  <li>MicrophoneClientWithIntent: Same functionality as MicrophoneClient. Additionally it will also send the text to LUIS and return LUIS entities and intents along with the text.</li>
  <li>DataClientWithIntent: Same as DataClient. Additionally it too will send the STT result to LUIS to perform intent and entity detection.</li>
</ul>

<p>In our scenario, we already receive voice stream from Skype and the NLP part will be done by our bot, therefore <code class="language-plaintext highlighter-rouge">DataClient</code> would work out for us.
Next we subscribe to event <code class="language-plaintext highlighter-rouge">OnResponseReceived</code>, as this will be raised once STT processing is done by Bing Speech for complete stream.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">void</span> <span class="nf">SendAudioHelper</span><span class="p">(</span><span class="n">Stream</span> <span class="n">recordedStream</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">bytesRead</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
    <span class="kt">byte</span><span class="p">[]</span> <span class="n">buffer</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="m">1024</span><span class="p">];</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="k">do</span>
        <span class="p">{</span>
            <span class="c1">// Get more Audio data to send into byte buffer.</span>
            <span class="n">bytesRead</span> <span class="p">=</span> <span class="n">recordedStream</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">buffer</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>

            <span class="c1">// Send of audio data to service.</span>
            <span class="k">this</span><span class="p">.</span><span class="n">dataClient</span><span class="p">.</span><span class="nf">SendAudio</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">bytesRead</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">bytesRead</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Exception ------------ "</span> <span class="p">+</span> <span class="n">ex</span><span class="p">.</span><span class="n">Message</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">finally</span>
    <span class="p">{</span>
        <span class="c1">// We are done sending audio.  Final recognition results will arrive in OnResponseReceived event call.</span>
        <span class="k">this</span><span class="p">.</span><span class="n">dataClient</span><span class="p">.</span><span class="nf">EndAudio</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">SendAudioHelper</code> will use dataClient to send the audio stream to Bing Speech Service. Once the entire stream is processed, the result will be available in <code class="language-plaintext highlighter-rouge">OnResponseReceived</code> event.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">async</span> <span class="k">void</span> <span class="nf">OnDataShortPhraseResponseReceivedHandler</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">SpeechResponseEventArgs</span> <span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">PhraseResponse</span><span class="p">.</span><span class="n">RecognitionStatus</span> <span class="p">==</span> <span class="n">RecognitionStatus</span><span class="p">.</span><span class="n">RecognitionSuccess</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">await</span> <span class="nf">SendToBot</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">PhraseResponse</span><span class="p">.</span><span class="n">Results</span>
                    <span class="p">.</span><span class="nf">OrderBy</span><span class="p">(</span><span class="n">k</span> <span class="p">=&gt;</span> <span class="n">k</span><span class="p">.</span><span class="n">Confidence</span><span class="p">)</span>
                    <span class="p">.</span><span class="nf">FirstOrDefault</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="nf">_failedCallback</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>If the STT conversion is successful, we order the result by confidence score and send it to our bot. Otherwise we call the callback for failure which sets a flag to true. This flag was then checked back at <code class="language-plaintext highlighter-rouge">OnPlayPromptCompleted</code> to either proceed or request caller to speak again.</p>

<h4 id="send-to-bot">Send to bot</h4>

<p>Next challenge is to take the STT result and construct a valid <code class="language-plaintext highlighter-rouge">Activity</code> instance. Why? Because everything in Bot Builder depends upon a proper instance of <code class="language-plaintext highlighter-rouge">IMessageActivity</code>. Moreover we need to wire-in our <code class="language-plaintext highlighter-rouge">BotToUserSpeech</code> class. We do this by registering it into Autofac <code class="language-plaintext highlighter-rouge">ConnectionBuilder</code> while starting a new <code class="language-plaintext highlighter-rouge">LifetimeScope</code>.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">SendToBot</span><span class="p">(</span><span class="n">RecognizedPhrase</span> <span class="n">recognizedPhrase</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Activity</span> <span class="n">activity</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Activity</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">From</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ChannelAccount</span> <span class="p">{</span> <span class="n">Id</span> <span class="p">=</span> <span class="n">conversationResult</span><span class="p">.</span><span class="n">Id</span> <span class="p">},</span>
        <span class="n">Conversation</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ConversationAccount</span>
        <span class="p">{</span>
            <span class="n">Id</span> <span class="p">=</span> <span class="n">conversationResult</span><span class="p">.</span><span class="n">Id</span>
        <span class="p">},</span>
        <span class="n">Recipient</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ChannelAccount</span> <span class="p">{</span> <span class="n">Id</span> <span class="p">=</span> <span class="s">"Bot"</span> <span class="p">},</span>
        <span class="n">ServiceUrl</span> <span class="p">=</span> <span class="s">"https://skype.botframework.com"</span><span class="p">,</span>
        <span class="n">ChannelId</span> <span class="p">=</span> <span class="s">"skype"</span><span class="p">,</span>
    <span class="p">};</span>

    <span class="n">activity</span><span class="p">.</span><span class="n">Text</span> <span class="p">=</span> <span class="n">recognizedPhrase</span><span class="p">.</span><span class="n">DisplayText</span><span class="p">;</span>

    <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">scope</span> <span class="p">=</span> <span class="n">Microsoft</span><span class="p">.</span><span class="n">Bot</span><span class="p">.</span><span class="n">Builder</span><span class="p">.</span><span class="n">Dialogs</span><span class="p">.</span><span class="n">Conversation</span>
      <span class="p">.</span><span class="n">Container</span><span class="p">.</span><span class="nf">BeginLifetimeScope</span><span class="p">(</span><span class="n">DialogModule</span><span class="p">.</span><span class="n">LifetimeScopeTag</span><span class="p">,</span> <span class="n">Configure</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">scope</span><span class="p">.</span><span class="n">Resolve</span><span class="p">&lt;</span><span class="n">IMessageActivity</span><span class="p">&gt;</span>
            <span class="p">(</span><span class="n">TypedParameter</span><span class="p">.</span><span class="nf">From</span><span class="p">((</span><span class="n">IMessageActivity</span><span class="p">)</span><span class="n">activity</span><span class="p">));</span>
        <span class="n">DialogModule_MakeRoot</span><span class="p">.</span><span class="nf">Register</span>
            <span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="n">Dialogs</span><span class="p">.</span><span class="nf">RentLuisDialog</span><span class="p">());</span>
        <span class="kt">var</span> <span class="n">postToBot</span> <span class="p">=</span> <span class="n">scope</span><span class="p">.</span><span class="n">Resolve</span><span class="p">&lt;</span><span class="n">IPostToBot</span><span class="p">&gt;();</span>
        <span class="k">await</span> <span class="n">postToBot</span><span class="p">.</span><span class="nf">PostAsync</span><span class="p">(</span><span class="n">activity</span><span class="p">,</span> <span class="n">CancellationToken</span><span class="p">.</span><span class="n">None</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">Configure</span><span class="p">(</span><span class="n">ContainerBuilder</span> <span class="n">builder</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">builder</span><span class="p">.</span><span class="nf">Register</span><span class="p">(</span><span class="n">c</span> <span class="p">=&gt;</span>
        <span class="k">new</span> <span class="nf">BotToUserSpeech</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">Resolve</span><span class="p">&lt;</span><span class="n">IMessageActivity</span><span class="p">&gt;(),</span> <span class="n">_callback</span><span class="p">))</span>
        <span class="p">.</span><span class="n">As</span><span class="p">&lt;</span><span class="n">IBotToUser</span><span class="p">&gt;()</span>
        <span class="p">.</span><span class="nf">InstancePerLifetimeScope</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">Activity</code> instance must be valid. At least the 3 IDs needs to be specified to get and set context from state service. For the IDs, we can use <code class="language-plaintext highlighter-rouge">ConversationResult.Id</code> which is a unique for each conversation. We also have <code class="language-plaintext highlighter-rouge">ConversationResult.AppId</code> which is AppId of the caller but for some reason it was always null for me. Along with them, ServiceUrl and ChannelId should also be correct, otherwise bot will throw exception. Once we have a valid <code class="language-plaintext highlighter-rouge">Activity</code> instance, we assign it’s text property to our STT output.</p>

<p>To send this <code class="language-plaintext highlighter-rouge">Activity</code> instance to the bot, we need to resolve instance of <code class="language-plaintext highlighter-rouge">IPostToBot</code>. Once we get it, we just call it’s <code class="language-plaintext highlighter-rouge">PostAsync</code> method and pass the <code class="language-plaintext highlighter-rouge">Activity</code> instance. This would kick start our bot, deserialize the Dialog State and resume/start the conversation. This is exact flow which happens when we call <code class="language-plaintext highlighter-rouge">Conversation.SendAsync</code> from <code class="language-plaintext highlighter-rouge">MessageController</code>.</p>

<h4 id="callingcontroller">CallingController</h4>

<p>Finally in <code class="language-plaintext highlighter-rouge">CallingController</code> pass the instance of <code class="language-plaintext highlighter-rouge">RentCarCallingBot</code> when registering the calling bot in the constructor.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="nf">CallingController</span><span class="p">()</span>
    <span class="p">:</span> <span class="k">base</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">CallingConversation</span><span class="p">.</span><span class="nf">RegisterCallingBot</span><span class="p">(</span><span class="n">c</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="nf">RentCarCallingBot</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="scalability-problems">Scalability Problems</h3>

<p>The response from bot will eventually arrive at our <code class="language-plaintext highlighter-rouge">BotToUserSpeech</code> class, which would just pass the response text to our delegate which would add it to a list maintained in <code class="language-plaintext highlighter-rouge">RentCarCallingBot</code>. The list is then monitored when the workflow is finished and Skype API sends us a callback with result. We have put together everything in such a that once the bot finishes user recording, it then plays a silent prompt and monitors the response list.</p>

<p>This is where the problem lies. Our <code class="language-plaintext highlighter-rouge">BotToUserSpeech</code> class will capture the response and add it to the List. However in scenario where we have scaled out and have multiple bot services running behind a load balance, there is no knowing where the next callback from Skype API is going to land. Our current implementation locks us to only single bot service and prevents us from scaling.</p>

<p>We can resolve this issue by changing our implementation of <code class="language-plaintext highlighter-rouge">BotToUserSpeech</code> class. For example, instead of passing the response to a delegate, we can push it into a queue such as RabbitMQ. On the <code class="language-plaintext highlighter-rouge">OnPlayPromptCompleted</code> method, we can then check if there are any messages in the queue to play to the user. We must also take care of posting message to the queue when STT failed. So in short, both our delegates needs to be replaced by an out of process storing mechanism which can be accessed by multiple running services. Since RabbitMQ or any other queue can be monitored by multiple bot services, it solves our scalability issue.</p>

<h3 id="testing-our-bot">Testing our bot</h3>

<p>We can test our bot locally by using ngrok. Ngrok creates a secure tunnel to localhost and provides us a public URL. Any call to public url will be forwarded to a service running on localhost at our system.
We create a tunnel <code class="language-plaintext highlighter-rouge">ngrok http --host-header=localhost 3999</code> to forward request to localhost:3999 where we will host our bot. Ngrok will then generate a random public URL. Note the https forwarding URL.</p>

<p><img src="/blog/assets/images/posts/skypecall/ngrok.png" alt="ngrok" /></p>

<p>The first place we need to change is in the web.config. Replace the value of <em>CallbackUrl</em> key by ngrok URL. It should look like <strong>https://&lt;ngrokURL&gt;/api/calling/callback</strong>.
Once we register our bot at <a href="https://dev.botframework.com">Bot Framework Portal</a>, click on <strong>Edit</strong> on Skype channel. We must enable <strong>1:1 audio calls</strong> feature. In the <em>Calling Webhook</em> text box, enter the ngrok URL in format of <strong>https://&lt;ngrokURL&gt;/api/calling/call</strong>.</p>

<p><img src="/blog/assets/images/posts/skypecall/registration.png" alt="registration" /></p>

<p>That’s it. Run the bot locally on the same port that was tunneled by ngrok. We can then start making calls to our bot. Try speaking “Rent a car from London”</p>

<h3 id="conclusion">Conclusion</h3>

<p>In the evolution of UI, and the advent of bot, it is only natural that the next logical step is to voice call the bot. Imagine just calling your self-driving car to pick you up from your current location. Can’t wait to live in such a world. The bot ecosystem is pretty new, and the voice call to bot feature itself is just emerging. The current platform is no where production ready. It’s messy and STT is not accurate especially for non-US accent. We may see drastic improvement in Bing Speech service and the new <a href="https://www.cris.ai/">CRIS</a> service looks promising. And with Microsoft achieving human parity in speech recognition, this dream may not be too far.</p>

  </div>
  <div class="PageNavigation">
  
  <div class="prevDiv">
    <a class="prev" href="/blog/2016/10/Microsoft-Bot-Framework-Use-Redis-to-store-conversation-state/">&laquo; Microsoft Bot Framework - Use Redis to store conversation state</a>
  </div>
  
  
  <div class="nextDiv">
    <a class="next" href="/blog/2017/01/BusyBot-Sykpe-For-Business-Bot/">BusyBot - Chat Bot for Skype for Business &raquo;</a>
  </div>
  
</div>
<!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="ankitbko/blog"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/blog/2016/11/skype-call-your-bot/" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/blog/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/blog/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/blog/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
        <ul class="contact-list">
          <li class="p-name">Ankit Sinha</li>
          
        </ul>
      </div>
      <div class="footer-col">
        <p>A technology blog focusing on random stuff</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/ankitbko" title="ankitbko"><svg class="svg-icon grey"><use xlink:href="/blog/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/ankitbko" title="ankitbko"><svg class="svg-icon grey"><use xlink:href="/blog/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
