<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Chatbot using Microsoft Bot Framework - Part 4</h1><p class="page-description">A guide on how to build chat bots using Microsoft Bot Framework - Part 4</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2016-09-23T00:00:00-05:00" itemprop="datePublished">
        Sep 23, 2016
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      9 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/blog/categories/#Microsoft Bot Framework">Microsoft Bot Framework</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#LUIS">LUIS</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#Bots">Bots</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#Chat Bots">Chat Bots</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#Conversational Apps">Conversational Apps</a>
        
      
      </p>
    

    
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>I finally got time to write another post and with this I will finish of my blog series on Microsoft Bot Framework. In my <a href="https://ankitbko.github.io/2016/08/ChatBot-using-Microsoft-Bot-Framework-Part-3/">last post</a>, we saw how to use other features of LUIS such as entities and phrase list. We also saw how to nest Dialogs and how to maintain context between Dialogs. If you are new to Microsoft Bot Framework, I highly recommend you go through <a href="https://ankitbko.github.io/2016/08/ChatBot-using-Microsoft-Bot-Framework-Part-1/">part 1</a>, <a href="https://ankitbko.github.io/2016/08/ChatBot-using-Microsoft-Bot-Framework-Part-2/">part 2</a> and <a href="https://ankitbko.github.io/2016/08/ChatBot-using-Microsoft-Bot-Framework-Part-3/">part 3</a> of my blog series before continuing. As usual, you can find source code at my <a href="https://github.com/ankitbko/MeBot/tree/part4">github repo</a>.</p>

<p>In this post, we will delve into how FormFlow works and where it can be used. We will add another feature to our bot which will let user to send feedback to me through chat.</p>

<h4 id="adding-feedback-intent">Adding Feedback Intent</h4>

<p>We first enhance LUIS by adding another intent called “Feedback”. I have trained LUIS for sentences such as “I want to send a feedback”, I will not go into details as I have already covered LUIS aspects in my previous posts. There are no entities to return so we just leave it to this.</p>

<p><img src="/blog/assets/images/posts/mebot-4/feedbackIntent.png" alt="Feedback" /></p>

<h3 id="formflow">FormFlow</h3>

<p>Till now we have only created conversations which are very shallow. In other words, it is a simple QA scenario where conversation does not flow deep and their are no context to maintain. However, there are many scenarios where we would need to take a more guided approach, where we may require multiple inputs from user and bot may take different path based on previous inputs. In short, we will need to create a state machine. A good example is ordering a pizza. We will need to ask a lot of questions such as size, crust, toppings, etc. and we will need to maintain them in the context. We will also need to provide a way for user to change previously entered data and we must only complete order once we have all the information with us. All of this would require managing a lot of state and workflow. This is where FormFlow comes in.</p>

<p>FormFlow sacrifices some of the flexibility of Dialogs to provide an easy way to achieve all the above. FormFlow itself is derived from <code class="language-plaintext highlighter-rouge">IDialog</code> so it can be nested within another dialog.</p>

<p>The basic idea behind <code class="language-plaintext highlighter-rouge">FormFlow</code> is <em>forms</em> i.e. collection of fields. Think of it as filling a form in any website. To order a pizza online, you would go to your favorite pizza restaurant’s website, fill out a <em>form</em> with details such as type of pizza, crust, size etc, put down delivery address and then order it. At any point before placing the order, you can revisit and change any aspect of pizza.</p>

<p>To accomplish the same using FormFlow, we start with creating a class and adding public fields or properties. Each public field and property corresponds to a <em>field in the form</em>. So the user will be asked to input values for each field before <em>completing</em> the form. The way FormFlow achieves this is by creating a state machine in background and maintaining the transition between states. It also allows user to change any previously entered value for any field and view the current status of the <em>form</em>. You can read more about FormFlow in the <a href="https://docs.botframework.com/en-us/csharp/builder/sdkreference/forms.html">docs here</a>.</p>

<p>In our scenario of implementing feedback functionality, before allowing user to send a feedback, we will ask him to enter his name and contact info. Only when we have both the information, would we allow him to send a feedback message. To achieve this, we first create a class called <code class="language-plaintext highlighter-rouge">FeedbackForm</code> and properties for <code class="language-plaintext highlighter-rouge">Name</code>, <code class="language-plaintext highlighter-rouge">Contact</code> and <code class="language-plaintext highlighter-rouge">Feedback</code>.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">FeedbackForm</span>
<span class="p">{</span>
    <span class="p">[</span><span class="nf">Prompt</span><span class="p">(</span><span class="k">new</span> <span class="kt">string</span><span class="p">[]</span> <span class="p">{</span> <span class="s">"What is your name?"</span> <span class="p">})]</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="p">[</span><span class="nf">Prompt</span><span class="p">(</span><span class="s">"How can Ankit contact you? You can enter either your email id or twitter handle (@something)"</span><span class="p">)]</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Contact</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="p">[</span><span class="nf">Prompt</span><span class="p">(</span><span class="s">"What's your feedback?"</span><span class="p">)]</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Feedback</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="n">IForm</span><span class="p">&lt;</span><span class="n">FeedbackForm</span><span class="p">&gt;</span> <span class="nf">BuildForm</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">FormBuilder</span><span class="p">&lt;</span><span class="n">FeedbackForm</span><span class="p">&gt;()</span>
            <span class="p">.</span><span class="nf">Field</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">Contact</span><span class="p">),</span> <span class="n">validate</span><span class="p">:</span> <span class="n">ValidateContactInformation</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">Field</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">Feedback</span><span class="p">),</span> <span class="n">active</span><span class="p">:</span> <span class="n">FeedbackEnabled</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">AddRemainingFields</span><span class="p">()</span>
            <span class="p">.</span><span class="nf">Build</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">Prompt</code> attribute on top of fields allow us to specify what message would be shown to the user for asking him to enter value for the respective fields. Do note that FormFlow only accepts .NET primitive types, <code class="language-plaintext highlighter-rouge">enum</code> and <code class="language-plaintext highlighter-rouge">List&lt;enum&gt;</code> as Type for properties or fields. The <code class="language-plaintext highlighter-rouge">BuildForm</code> static method returns an <code class="language-plaintext highlighter-rouge">IForm&lt;&gt;</code> which would be used by <code class="language-plaintext highlighter-rouge">FormDialog</code> to build forms later. I will explain each line of the method -</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">new FormBuilder&lt;FeedbackForm&gt;()</code>: Create a new FormBuilder of type FeedbackForm. FormBuilder has fluent api to help us build it.</li>
  <li><code class="language-plaintext highlighter-rouge">.Field(nameof(Contact), validate: ValidateContactInformation)</code>: Add the property <code class="language-plaintext highlighter-rouge">Contact</code> to the form and set a delegate to validate the input. ValidateContactInformation delegate will be called whenever user inputs for this field.</li>
  <li><code class="language-plaintext highlighter-rouge">.Field(nameof(Feedback), active: FeedbackEnabled)</code>: Add the property <code class="language-plaintext highlighter-rouge">Feedback</code> to the form and assign an <code class="language-plaintext highlighter-rouge">ActiveDelegate</code> to it. This means that this field will be visible only when <code class="language-plaintext highlighter-rouge">ActiveDelegate</code> returns <code class="language-plaintext highlighter-rouge">true</code>.</li>
  <li><code class="language-plaintext highlighter-rouge">.AddRemainingFields()</code>: Add any remaining valid public fields and properties to the form. In this case <code class="language-plaintext highlighter-rouge">Name</code>.</li>
  <li><code class="language-plaintext highlighter-rouge">.Build();</code>: Build the form and return an <code class="language-plaintext highlighter-rouge">IForm&lt;FeedbackForm&gt;</code>.</li>
</ul>

<p>The <code class="language-plaintext highlighter-rouge">ValidateContactInformation</code> delegate validates that the input is either a valid email address or starts with ‘@’ to signify twitter handle.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">static</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">ValidateResult</span><span class="p">&gt;</span> <span class="nf">ValidateContactInformation</span><span class="p">(</span><span class="n">FeedbackForm</span> <span class="n">state</span><span class="p">,</span> <span class="kt">object</span> <span class="n">response</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ValidateResult</span><span class="p">();</span>
    <span class="kt">string</span> <span class="n">contactInfo</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="nf">GetTwitterHandle</span><span class="p">((</span><span class="kt">string</span><span class="p">)</span><span class="n">response</span><span class="p">,</span> <span class="k">out</span> <span class="n">contactInfo</span><span class="p">)</span> <span class="p">||</span> <span class="nf">GetEmailAddress</span><span class="p">((</span><span class="kt">string</span><span class="p">)</span><span class="n">response</span><span class="p">,</span> <span class="k">out</span> <span class="n">contactInfo</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">result</span><span class="p">.</span><span class="n">IsValid</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="n">result</span><span class="p">.</span><span class="n">Value</span> <span class="p">=</span> <span class="n">contactInfo</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">result</span><span class="p">.</span><span class="n">IsValid</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
        <span class="n">result</span><span class="p">.</span><span class="n">Feedback</span> <span class="p">=</span> <span class="s">"You did not enter valid email address or twitter handle. Make sure twitter handle starts with @."</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="nf">FromResult</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">ValidateAsyncDelegate</code> must return a <code class="language-plaintext highlighter-rouge">ValidateResult</code> object whose property <code class="language-plaintext highlighter-rouge">IsValid</code> should be set appropriately. If <code class="language-plaintext highlighter-rouge">IsValid</code> is set to <code class="language-plaintext highlighter-rouge">true</code>, FormFlow will assign the field to the value in <code class="language-plaintext highlighter-rouge">Value</code> property. This gives us chance to transform the user input before assigning it to the form. If the <code class="language-plaintext highlighter-rouge">IsValid</code> is set to <code class="language-plaintext highlighter-rouge">false</code>, text in <code class="language-plaintext highlighter-rouge">Feedback</code> field will be displayed to the user. This allows us to notify user why validation failed and give clear instructions as to what to do next. If the validation fails, the FormFlow will ask user to enter the value again.</p>

<p>Each field can be controlled as to whether it is available to be filled or not by <code class="language-plaintext highlighter-rouge">ActiveDelegate</code>. The <code class="language-plaintext highlighter-rouge">ActiveDelegate</code> returns a <code class="language-plaintext highlighter-rouge">bool</code>, if it is <code class="language-plaintext highlighter-rouge">true</code> the field is available to be filled by the user else it will be not be shown.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">private</span> <span class="k">static</span> <span class="kt">bool</span> <span class="nf">FeedbackEnabled</span><span class="p">(</span><span class="n">FeedbackForm</span> <span class="n">state</span><span class="p">)</span> <span class="p">=&gt;</span>
    <span class="p">!</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrWhiteSpace</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">Contact</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="p">!</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrWhiteSpace</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
</code></pre></div></div>

<p>This completes creation of our form, next we will add an intent handler.</p>

<h4 id="add-handler-for-feedback-intent">Add handler for Feedback intent</h4>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="nf">LuisIntent</span><span class="p">(</span><span class="s">"Feedback"</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">Feedback</span><span class="p">(</span><span class="n">IDialogContext</span> <span class="n">context</span><span class="p">,</span> <span class="n">LuisResult</span> <span class="n">result</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="k">await</span> <span class="n">context</span><span class="p">.</span><span class="nf">PostAsync</span><span class="p">(</span><span class="s">"That's great. You will need to provide few details about yourself before giving feedback."</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">feedbackForm</span> <span class="p">=</span> <span class="k">new</span> <span class="n">FormDialog</span><span class="p">&lt;</span><span class="n">FeedbackForm</span><span class="p">&gt;(</span><span class="k">new</span> <span class="nf">FeedbackForm</span><span class="p">(),</span> <span class="n">FeedbackForm</span><span class="p">.</span><span class="n">BuildForm</span><span class="p">,</span> <span class="n">FormOptions</span><span class="p">.</span><span class="n">PromptInStart</span><span class="p">);</span>
        <span class="n">context</span><span class="p">.</span><span class="nf">Call</span><span class="p">(</span><span class="n">feedbackForm</span><span class="p">,</span> <span class="n">FeedbackFormComplete</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">await</span> <span class="n">context</span><span class="p">.</span><span class="nf">PostAsync</span><span class="p">(</span><span class="s">"Something really bad happened. You can try again later meanwhile I'll check what went wrong."</span><span class="p">);</span>
        <span class="n">context</span><span class="p">.</span><span class="nf">Wait</span><span class="p">(</span><span class="n">MessageReceived</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Here we create a new <code class="language-plaintext highlighter-rouge">FormDialog</code> object by passing the new instance of <code class="language-plaintext highlighter-rouge">FeedbackForm</code> and <code class="language-plaintext highlighter-rouge">BuildFormDelegate</code> which we have defined above. The <code class="language-plaintext highlighter-rouge">BuildFormDelegate</code> will be used by FormFlow to build the form. <code class="language-plaintext highlighter-rouge">FormOptions.PromptInStart</code> tells the bot to prompt user for the first field to be filled as soon as the dialog starts. FormDialog has another optional parameter which takes <code class="language-plaintext highlighter-rouge">IEnumerable&lt;EntityRecommendation&gt;</code>. This can be used to pass the entities returned by the LUIS and FormFlow will <em>pre-populate</em> the form and will not ask the user to fill in those fields.</p>

<p>Next we use <code class="language-plaintext highlighter-rouge">context.Call</code> to push our <code class="language-plaintext highlighter-rouge">FormDialog</code> to top of the <code class="language-plaintext highlighter-rouge">DialogStack</code>. Unlike <code class="language-plaintext highlighter-rouge">context.Forward</code>, <code class="language-plaintext highlighter-rouge">context.Call</code> will not pass the current message to the Dialog. Instead the next message from the user will be routed to the child dialog.</p>

<p><code class="language-plaintext highlighter-rouge">FeedbackFormComplete</code> is called once all the fields in the our form is successfully filled and the form completes. I also get the completed form passed in the <code class="language-plaintext highlighter-rouge">result</code> parameter.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">FeedbackFormComplete</span><span class="p">(</span><span class="n">IDialogContext</span> <span class="n">context</span><span class="p">,</span> <span class="n">IAwaitable</span><span class="p">&lt;</span><span class="n">FeedbackForm</span><span class="p">&gt;</span> <span class="n">result</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">feedback</span> <span class="p">=</span> <span class="k">await</span> <span class="n">result</span><span class="p">;</span>
        <span class="kt">string</span> <span class="n">message</span> <span class="p">=</span> <span class="nf">GenerateEmailMessage</span><span class="p">(</span><span class="n">feedback</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">success</span> <span class="p">=</span> <span class="k">await</span> <span class="n">EmailSender</span><span class="p">.</span><span class="nf">SendEmail</span><span class="p">(</span><span class="n">recipientEmail</span><span class="p">,</span> <span class="n">senderEmail</span><span class="p">,</span> <span class="s">$"Email from </span><span class="p">{</span><span class="n">feedback</span><span class="p">.</span><span class="n">Name</span><span class="p">}</span><span class="s">"</span><span class="p">,</span> <span class="n">message</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(!</span><span class="n">success</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">context</span><span class="p">.</span><span class="nf">PostAsync</span><span class="p">(</span><span class="s">"I was not able to send your message. Something went wrong."</span><span class="p">);</span>
        <span class="k">else</span>
		<span class="p">{</span>
            <span class="k">await</span> <span class="n">context</span><span class="p">.</span><span class="nf">PostAsync</span><span class="p">(</span><span class="s">"Thanks for the feedback."</span><span class="p">);</span>
			<span class="k">await</span> <span class="n">context</span><span class="p">.</span><span class="nf">PostAsync</span><span class="p">(</span><span class="s">"What else would you like to do?"</span><span class="p">);</span>
		<span class="p">}</span>

    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="n">FormCanceledException</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">await</span> <span class="n">context</span><span class="p">.</span><span class="nf">PostAsync</span><span class="p">(</span><span class="s">"Don't want to send feedback? That's ok. You can drop a comment below."</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">await</span> <span class="n">context</span><span class="p">.</span><span class="nf">PostAsync</span><span class="p">(</span><span class="s">"Something really bad happened. You can try again later meanwhile I'll check what went wrong."</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">finally</span>
    <span class="p">{</span>
        <span class="n">context</span><span class="p">.</span><span class="nf">Wait</span><span class="p">(</span><span class="n">MessageReceived</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>I use SendGrid to send a mail to myself with the feedback message which I get from completed form. The interesting part here is the catch block for <code class="language-plaintext highlighter-rouge">FormCanceledException</code>.
<code class="language-plaintext highlighter-rouge">FormCanceledException</code> is thrown when user quits or cancels the form. This is another feature of FormFlow. User can quit the form anytime by typing ‘quit’ or ‘bye’. Along with this, user can type ‘Help’ anytime to view all the available options if he feels stuck anywhere and ‘Status’ to view the current state of form. These <em>commands</em> are configurable and list of them is available in ‘Help’ menu.</p>

<p><img src="/blog/assets/images/posts/mebot-4/help.png" alt="Help" />
<img src="/blog/assets/images/posts/mebot-4/status.png" alt="Status" /></p>

<h3 id="wrapping-up">Wrapping up</h3>
<p>This is it. We have created a bot and in the process I have explained fundamentals of bots and Microsoft Bot Framework. But in no way have I touched upon every feature of Bot Framework. There are many other features such as <code class="language-plaintext highlighter-rouge">Scorable</code>, <code class="language-plaintext highlighter-rouge">BotState</code>, <code class="language-plaintext highlighter-rouge">IPostToBot</code>, <code class="language-plaintext highlighter-rouge">IBotToUser</code> etc. which are very useful and you should definitely explore. Voice calling through Skype is an upcoming feature which can be integrated to the bot. There are many other cognitive services which can be integrated with bots to make it more smarter. Microsoft Bot Framework is a powerful and feature rich platform to build bots. The open source community around it is great and developers are quick to respond to any issues.</p>

<p>I will write more about above things in future. If you have any specific topic which you would like me to write about, drop a comment or send a feedback through bot :).</p>

  </div>
  <div class="PageNavigation">
  
  <div class="prevDiv">
    <a class="prev" href="/blog/2016/08/ChatBot-using-Microsoft-Bot-Framework-Part-3/">&laquo; Chatbot using Microsoft Bot Framework - Part 3</a>
  </div>
  
  
  <div class="nextDiv">
    <a class="next" href="/blog/2016/10/Hidden-Gem-in-Microsoft-Bot-Framework-QnA-Maker/">Hidden Gem in Microsoft Bot Framework - QnA Maker &raquo;</a>
  </div>
  
</div>
<!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="ankitbko/blog"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/blog/2016/09/ChatBot-using-Microsoft-Bot-Framework-Part-4/" hidden></a>
</article>