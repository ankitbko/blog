<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">IdentityServer4 on Docker</h1><p class="page-description">A tutorial on how to host IdentityServer 4 on Docker</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2016-03-28T00:00:00-05:00" itemprop="datePublished">
        Mar 28, 2016
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      6 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/blog/categories/#.net core">.net core</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#docker">docker</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#IdentityServer">IdentityServer</a>
        
      
      </p>
    

    
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <div class="message">
<strong>Update - 18 August 2016</strong>
<br />
This article was written when ASP.NET Core was in RC1. ASP.NET Core 1.0 was released in June 2016 which had some breaking changes. I have updated my repo and written a new post which explains the changes required to target ASP.NET Core 1.0. You can find it <a href="https://ankitbko.github.io/2016/08/IdentityServer4-on-Docker-netcorertm/">here</a>.
</div>

<p>With Microsoft supporting .NET on Linux and docker supporting running containers on Windows, its a great time to be working on .NET stack. Now you can develop and test .NET code on containers directly from Windows without having to switch OS. Moreover Docker is <a href="https://blog.docker.com/2016/03/docker-for-mac-windows-beta/">beta testing</a> its new program which makes running containers on Windows much easier. For this post we will go oldschool and use docker toolbox.</p>

<h3 id="what-is-identityserver">What is IdentityServer?</h3>

<p><a href="https://github.com/identityserver">IdentityServer</a> is an open source .NET implementation of OpenId Connect protocol. I have been following its development deeply since I came to know about it last year. IdentityServer4 is being developed completely on ASP.NET Core which means if built on .NET Core, it would work cross platform.</p>

<p><em>Note: While writing this article, IdentityServer4 is in Beta. Some features such as session management is not implemented yet.</em></p>

<p>Below I would detail on how to host IdentityServer4(IdSrv in short), a sample API which checks for access token and a simple javascript client in docker running on Windows. The code can be found in my <a href="https://github.com/ankitbko/IdentityServer4.DockerSample">github repo</a>. This repo is essentially a fork of <a href="https://github.com/IdentityServer/IdentityServer4.Samples">IdentityServer4 Samples</a> with few changes where I have deleted other clients and changed some configurations URLs (more detail below). Lets get started.</p>

<h4 id="get-docker">Get Docker</h4>

<p>Install Docker Toolbox for Windows by following instructions <a href="https://docs.docker.com/engine/installation/windows/">here</a>.</p>

<h4 id="create-a-docker-vm">Create a Docker VM</h4>

<p>Create a new Docker VM by writing following command in Command Prompt.</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nf">docker-machine</span><span class="w"> </span><span class="nx">create</span><span class="w"> </span><span class="nt">--driver</span><span class="w"> </span><span class="nx">virtualbox</span><span class="w"> </span><span class="nt">--virtualbox-no-vtx-check</span><span class="w"> </span><span class="nx">idsrv-demo</span></code></pre></figure>

<p>Docker Toolbox installs Oracle VirtualBox which has known issue if you have hyper-v installed. In case you are experiencing issues while creating Docker VM, follow <a href="http://www.hanselman.com/blog/SwitchEasilyBetweenVirtualBoxAndHyperVWithABCDEditBootEntryInWindows81.aspx">Hanselman’s post</a> on how to switch between hyper-v and virtualbox.</p>

<p>Lets break down the above command.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">docker-machine</code>: Docker Machine allows us to provision and manage our Dockerized hosts (hosts with Docker Engine on them).</li>
  <li><code class="language-plaintext highlighter-rouge">create</code>: Create command creates a Linux Virtual Machine and installs docker engine to it.</li>
  <li><code class="language-plaintext highlighter-rouge">--driver virtualbox</code>: Docker Machine supports multiple virtualization options and environment. We will be using virtualbox which comes installed with docker toolbox. Have a look at <a href="https://docs.docker.com/machine/drivers/">complete list</a> of supported driver for more information.</li>
  <li><code class="language-plaintext highlighter-rouge">--virtualbox-no-vtx</code>: This is only required if you have Hyper-v installed and have disabled Hyper-v. This command disables checking for other hardware virtualization before VM is started.</li>
  <li><code class="language-plaintext highlighter-rouge">idsrv-demo</code>: Name of the virtual machine which will be created.</li>
</ul>

<p>Run <code class="language-plaintext highlighter-rouge">docker-machine ls</code> to verify if the VM is created and running. Note the URL of the VM. This URL will be used to access any application in containers hosted on this VM.</p>

<p><img src="/blog/assets/images/posts/Id4-on-docker/docker-machine-ls.png" alt="docker-machine ls" /></p>

<p>Setup the environment by running <code class="language-plaintext highlighter-rouge">docker-machine env --shell=cmd idsrv-demo</code> and following the instructions at prompt.</p>

<p><img src="/blog/assets/images/posts/Id4-on-docker/docker-machine-env.png" alt="docker-machine env" /></p>

<h4 id="change-urls-in-the-code">Change URLs in the code</h4>

<p>You will have to change the URLs in your code to point to the new VM URL in the following places:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">IdSrvHost\Configuration\Clients.cs</code>: Change all the URL here to point to the VM. Leave the port to 7017 as we will host our client on the same port.</li>
  <li><code class="language-plaintext highlighter-rouge">SampleApi\Startup.cs</code>: Change the URL in <code class="language-plaintext highlighter-rouge">app.UseIdentityServerAuthentication</code>. Leave the port as 22530.</li>
  <li><code class="language-plaintext highlighter-rouge">JavaScript Oidc\wwwroot\index.html</code>: There are two places in this file where URL needs to be changed. Leave the port number as it is in each place.</li>
  <li><code class="language-plaintext highlighter-rouge">project.json</code> in each project: Change the <code class="language-plaintext highlighter-rouge">web</code> command to pass option to Kestrel to listen to specific URL. This is required as by default the docker container will start the application and listen to <code class="language-plaintext highlighter-rouge">0.0.0.0</code> which is not same as <code class="language-plaintext highlighter-rouge">localhost</code>. Port number here specifies which port needs to be opened in docker container. This is already been done in my sample. In case you are using your own code, do the following changes.
    <ul>
      <li>IdSrvHost: <code class="language-plaintext highlighter-rouge">"web": "Microsoft.AspNet.Server.Kestrel --server.urls=http://0.0.0.0:22530</code></li>
      <li>Javascript Oidc: <code class="language-plaintext highlighter-rouge">"web": "Microsoft.AspNet.Server.Kestrel --server.urls=http://0.0.0.0:7017</code></li>
      <li>SampleApi: <code class="language-plaintext highlighter-rouge">"web": "Microsoft.AspNet.Server.Kestrel --server.urls=http://0.0.0.0:3860</code></li>
    </ul>
  </li>
</ul>

<h4 id="publish-the-projects">Publish the projects</h4>

<p>Go to each project folder and run <code class="language-plaintext highlighter-rouge">dnu publish</code> to publish in your desired folder.</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nf">dnu</span><span class="w"> </span><span class="nx">publish</span><span class="w"> </span><span class="nt">-o</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">Path</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">output</span><span class="w"> </span><span class="nx">directory</span><span class="err">&gt;</span></code></pre></figure>

<h4 id="add-a-dockerfile">Add a Dockerfile</h4>

<p>Create a platintext file and name it as Dockerfile (without extension) in the root of  output of each of the published project. It should sit together with approot, wwwroot and logs folder.
Paste the following content in the Dockerfile.</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">FROM microsoft/aspnet:1.0.0-rc1-update1-coreclr

COPY <span class="nb">.</span> /app
WORKDIR /app/approot

EXPOSE &lt;PORT&gt;
ENTRYPOINT <span class="o">[</span><span class="s2">"./web"</span><span class="o">]</span></code></pre></figure>

<ul>
  <li><code class="language-plaintext highlighter-rouge">FROM microsoft/aspnet:1.0.0-rc1-update1-coreclr</code>: Docker creates the container on a base image. Docker runs each following instructions on top of this base image. Here we use aspnet image provided by Microsoft. To learn more visit the <a href="https://hub.docker.com/r/microsoft/aspnet/">docker hub</a>.</li>
  <li><code class="language-plaintext highlighter-rouge">COPY . /app</code>: Copy the current folder to <code class="language-plaintext highlighter-rouge">/app</code> folder in container.</li>
  <li><code class="language-plaintext highlighter-rouge">WORKDIR /app/approot</code>: Set the WORKDIR to /app/approot folder. This sets the working directory in container and executes remaining command from this directory.</li>
  <li><code class="language-plaintext highlighter-rouge">EXPOSE &lt;PORT&gt;</code>: <code class="language-plaintext highlighter-rouge">EXPOSE</code> instruction informs Docker that the container listens on the specified network ports at runtime. <code class="language-plaintext highlighter-rouge">EXPOSE</code> does not make the ports of the container accessible to the host. We will do that later during creating container. Substitute <PORT> for appropriate port as mentioned in project.json above.
</PORT>    <ul>
      <li>IdSrvHost: 22530</li>
      <li>Javascript Oidc: 7017</li>
      <li>SampleApi: 3860</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">ENTRYPOINT ["./web"]</code>: This instruction will execute <code class="language-plaintext highlighter-rouge">web</code> script in current folder. Note that we had changed the working directory to <code class="language-plaintext highlighter-rouge">/app/approot</code>.</li>
</ul>

<h4 id="build-image">Build Image</h4>

<p>Go to the root of the published output of each project and run the following command to create a new image. This will download the base image from docker hub and may take time depending upon internet connection.</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nf">docker</span><span class="w"> </span><span class="nx">build</span><span class="w"> </span><span class="nt">-t</span><span class="w"> </span><span class="nx">idsrvhost</span><span class="w"> </span><span class="o">.</span></code></pre></figure>

<ul>
  <li><code class="language-plaintext highlighter-rouge">docker build</code>: Builds a new image from Dockerfile</li>
  <li><code class="language-plaintext highlighter-rouge">-t idsrvhost</code>: Sets the tag of the image.</li>
  <li><code class="language-plaintext highlighter-rouge">.</code>: The PATH to build the image from. By default docker searches for Dockerfile in PATH/Dockerfile.</li>
</ul>

<p><img src="/blog/assets/images/posts/Id4-on-docker/docker-build.png" alt="docker build" /></p>

<p>Do the same for each of the projects but change the tag name. Run <code class="language-plaintext highlighter-rouge">docker images</code> to view all the generated image.</p>

<p><img src="/blog/assets/images/posts/Id4-on-docker/docker-image.png" alt="docker images" /></p>

<h4 id="create-the-container">Create the container</h4>

<p>We will create one container for each image. Run the following commands to create and start the containers.</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nf">docker</span><span class="w"> </span><span class="nx">run</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="nt">-p</span><span class="w"> </span><span class="nx">22530:22530</span><span class="w"> </span><span class="nt">--name</span><span class="w"> </span><span class="nx">idsrv-host</span><span class="w"> </span><span class="nx">idsrvhost</span><span class="w">
</span><span class="nf">docker</span><span class="w"> </span><span class="nx">run</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="nt">-p</span><span class="w"> </span><span class="nx">7017:7017</span><span class="w"> </span><span class="nt">--name</span><span class="w"> </span><span class="nx">client</span><span class="w"> </span><span class="nx">jsclient</span><span class="w">
</span><span class="nf">docker</span><span class="w"> </span><span class="nx">run</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="nt">-p</span><span class="w"> </span><span class="nx">3860:3860</span><span class="w"> </span><span class="nt">--name</span><span class="w"> </span><span class="nx">api</span><span class="w"> </span><span class="nx">sampleapi</span></code></pre></figure>

<ul>
  <li><code class="language-plaintext highlighter-rouge">docker run</code>: Creates and start a new container.</li>
  <li><code class="language-plaintext highlighter-rouge">-d</code>: Run the container in background.</li>
  <li><code class="language-plaintext highlighter-rouge">-p &lt;host&gt;:&lt;container&gt;</code>: Map the specified port of host to the port container.</li>
  <li><code class="language-plaintext highlighter-rouge">--name &lt;ContainerName&gt;</code>: Creates the container with the specified name.</li>
  <li>The last parameter is the name of the image from which to create the container.</li>
</ul>

<p>Run <code class="language-plaintext highlighter-rouge">docker ps</code> to view all the created containers.</p>

<p><img src="/blog/assets/images/posts/Id4-on-docker/docker-ps.png" alt="docker ps" /></p>

<h4 id="thats-it">Thats it.</h4>

<p>Open the browser and go to the URL:PORT to view each of the site. Open URL:7017 to play with the javascript client.</p>

<p><img src="/blog/assets/images/posts/Id4-on-docker/client-running.png" alt="client" /></p>

<h3 id="conclusion">Conclusion</h3>
<p>Docker is great and very easy once you get hang of it. Next step you can try <code class="language-plaintext highlighter-rouge">-v</code> command to mount the source code to container without having to publish the site. This is incredibly helpful during development where you want to avoid hassle of publishing and creating new images every time you make a change.</p>

  </div>
  <div class="PageNavigation">
  
  <div class="prevDiv">
    <a class="prev"></a>
  </div>
  
  
  <div class="nextDiv">
    <a class="next" href="/blog/2016/08/IdentityServer4-on-Docker-netcorertm/">IdentityServer4 on Docker (ASP.NET Core 1.0) &raquo;</a>
  </div>
  
</div>
<!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="ankitbko/blog"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/blog/2016/03/IdentityServer4-on-Docker/" hidden></a>
</article>