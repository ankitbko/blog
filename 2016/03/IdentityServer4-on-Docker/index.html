<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>IdentityServer4 on Docker | F5 - Squashing Bugs</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="IdentityServer4 on Docker" />
<meta name="author" content="Ankit Sinha" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="A tutorial on how to host IdentityServer 4 on Docker" />
<meta property="og:description" content="A tutorial on how to host IdentityServer 4 on Docker" />
<link rel="canonical" href="https://ankitbko.github.io/blog/2016/03/IdentityServer4-on-Docker/" />
<meta property="og:url" content="https://ankitbko.github.io/blog/2016/03/IdentityServer4-on-Docker/" />
<meta property="og:site_name" content="F5 - Squashing Bugs" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2016-03-28T00:00:00-05:00" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Ankit Sinha"},"description":"A tutorial on how to host IdentityServer 4 on Docker","mainEntityOfPage":{"@type":"WebPage","@id":"https://ankitbko.github.io/blog/2016/03/IdentityServer4-on-Docker/"},"@type":"BlogPosting","url":"https://ankitbko.github.io/blog/2016/03/IdentityServer4-on-Docker/","headline":"IdentityServer4 on Docker","dateModified":"2016-03-28T00:00:00-05:00","datePublished":"2016-03-28T00:00:00-05:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/blog/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://ankitbko.github.io/blog/feed.xml" title="F5 - Squashing Bugs" /><!-- the google_analytics_id gets auto inserted from the config file -->



<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-75679348-1','auto');ga('require','displayfeatures');ga('send','pageview');</script>

<link rel="shortcut icon" type="image/x-icon" href="/blog/images/favicon.ico"><link href="https://unpkg.com/@primer/css/dist/primer.css" rel="stylesheet" />
<link rel="stylesheet" href="//use.fontawesome.com/releases/v5.0.7/css/all.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"> </script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/blog/">F5 - Squashing Bugs</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/blog/about/">About Me</a><a class="page-link" href="/blog/search/">Search</a><a class="page-link" href="/blog/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">IdentityServer4 on Docker</h1><p class="page-description">A tutorial on how to host IdentityServer 4 on Docker</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2016-03-28T00:00:00-05:00" itemprop="datePublished">
        Mar 28, 2016
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      6 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/blog/categories/#.net core">.net core</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#docker">docker</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#IdentityServer">IdentityServer</a>
        
      
      </p>
    

    
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <div class="message">
<strong>Update - 18 August 2016</strong>
<br />
This article was written when ASP.NET Core was in RC1. ASP.NET Core 1.0 was released in June 2016 which had some breaking changes. I have updated my repo and written a new post which explains the changes required to target ASP.NET Core 1.0. You can find it <a href="https://ankitbko.github.io/2016/08/IdentityServer4-on-Docker-netcorertm/">here</a>.
</div>

<p>With Microsoft supporting .NET on Linux and docker supporting running containers on Windows, its a great time to be working on .NET stack. Now you can develop and test .NET code on containers directly from Windows without having to switch OS. Moreover Docker is <a href="https://blog.docker.com/2016/03/docker-for-mac-windows-beta/">beta testing</a> its new program which makes running containers on Windows much easier. For this post we will go oldschool and use docker toolbox.</p>

<h3 id="what-is-identityserver">What is IdentityServer?</h3>

<p><a href="https://github.com/identityserver">IdentityServer</a> is an open source .NET implementation of OpenId Connect protocol. I have been following its development deeply since I came to know about it last year. IdentityServer4 is being developed completely on ASP.NET Core which means if built on .NET Core, it would work cross platform.</p>

<p><em>Note: While writing this article, IdentityServer4 is in Beta. Some features such as session management is not implemented yet.</em></p>

<p>Below I would detail on how to host IdentityServer4(IdSrv in short), a sample API which checks for access token and a simple javascript client in docker running on Windows. The code can be found in my <a href="https://github.com/ankitbko/IdentityServer4.DockerSample">github repo</a>. This repo is essentially a fork of <a href="https://github.com/IdentityServer/IdentityServer4.Samples">IdentityServer4 Samples</a> with few changes where I have deleted other clients and changed some configurations URLs (more detail below). Lets get started.</p>

<h4 id="get-docker">Get Docker</h4>

<p>Install Docker Toolbox for Windows by following instructions <a href="https://docs.docker.com/engine/installation/windows/">here</a>.</p>

<h4 id="create-a-docker-vm">Create a Docker VM</h4>

<p>Create a new Docker VM by writing following command in Command Prompt.</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nf">docker-machine</span><span class="w"> </span><span class="nx">create</span><span class="w"> </span><span class="nt">--driver</span><span class="w"> </span><span class="nx">virtualbox</span><span class="w"> </span><span class="nt">--virtualbox-no-vtx-check</span><span class="w"> </span><span class="nx">idsrv-demo</span></code></pre></figure>

<p>Docker Toolbox installs Oracle VirtualBox which has known issue if you have hyper-v installed. In case you are experiencing issues while creating Docker VM, follow <a href="http://www.hanselman.com/blog/SwitchEasilyBetweenVirtualBoxAndHyperVWithABCDEditBootEntryInWindows81.aspx">Hanselman’s post</a> on how to switch between hyper-v and virtualbox.</p>

<p>Lets break down the above command.</p>

<ul>
  <li><code class="highlighter-rouge">docker-machine</code>: Docker Machine allows us to provision and manage our Dockerized hosts (hosts with Docker Engine on them).</li>
  <li><code class="highlighter-rouge">create</code>: Create command creates a Linux Virtual Machine and installs docker engine to it.</li>
  <li><code class="highlighter-rouge">--driver virtualbox</code>: Docker Machine supports multiple virtualization options and environment. We will be using virtualbox which comes installed with docker toolbox. Have a look at <a href="https://docs.docker.com/machine/drivers/">complete list</a> of supported driver for more information.</li>
  <li><code class="highlighter-rouge">--virtualbox-no-vtx</code>: This is only required if you have Hyper-v installed and have disabled Hyper-v. This command disables checking for other hardware virtualization before VM is started.</li>
  <li><code class="highlighter-rouge">idsrv-demo</code>: Name of the virtual machine which will be created.</li>
</ul>

<p>Run <code class="highlighter-rouge">docker-machine ls</code> to verify if the VM is created and running. Note the URL of the VM. This URL will be used to access any application in containers hosted on this VM.</p>

<p><img src="/blog/assets/images/posts/Id4-on-docker/docker-machine-ls.png" alt="docker-machine ls" /></p>

<p>Setup the environment by running <code class="highlighter-rouge">docker-machine env --shell=cmd idsrv-demo</code> and following the instructions at prompt.</p>

<p><img src="/blog/assets/images/posts/Id4-on-docker/docker-machine-env.png" alt="docker-machine env" /></p>

<h4 id="change-urls-in-the-code">Change URLs in the code</h4>

<p>You will have to change the URLs in your code to point to the new VM URL in the following places:</p>

<ul>
  <li><code class="highlighter-rouge">IdSrvHost\Configuration\Clients.cs</code>: Change all the URL here to point to the VM. Leave the port to 7017 as we will host our client on the same port.</li>
  <li><code class="highlighter-rouge">SampleApi\Startup.cs</code>: Change the URL in <code class="highlighter-rouge">app.UseIdentityServerAuthentication</code>. Leave the port as 22530.</li>
  <li><code class="highlighter-rouge">JavaScript Oidc\wwwroot\index.html</code>: There are two places in this file where URL needs to be changed. Leave the port number as it is in each place.</li>
  <li><code class="highlighter-rouge">project.json</code> in each project: Change the <code class="highlighter-rouge">web</code> command to pass option to Kestrel to listen to specific URL. This is required as by default the docker container will start the application and listen to <code class="highlighter-rouge">0.0.0.0</code> which is not same as <code class="highlighter-rouge">localhost</code>. Port number here specifies which port needs to be opened in docker container. This is already been done in my sample. In case you are using your own code, do the following changes.
    <ul>
      <li>IdSrvHost: <code class="highlighter-rouge">"web": "Microsoft.AspNet.Server.Kestrel --server.urls=http://0.0.0.0:22530</code></li>
      <li>Javascript Oidc: <code class="highlighter-rouge">"web": "Microsoft.AspNet.Server.Kestrel --server.urls=http://0.0.0.0:7017</code></li>
      <li>SampleApi: <code class="highlighter-rouge">"web": "Microsoft.AspNet.Server.Kestrel --server.urls=http://0.0.0.0:3860</code></li>
    </ul>
  </li>
</ul>

<h4 id="publish-the-projects">Publish the projects</h4>

<p>Go to each project folder and run <code class="highlighter-rouge">dnu publish</code> to publish in your desired folder.</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nf">dnu</span><span class="w"> </span><span class="nx">publish</span><span class="w"> </span><span class="nt">-o</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">Path</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">output</span><span class="w"> </span><span class="nx">directory</span><span class="err">&gt;</span></code></pre></figure>

<h4 id="add-a-dockerfile">Add a Dockerfile</h4>

<p>Create a platintext file and name it as Dockerfile (without extension) in the root of  output of each of the published project. It should sit together with approot, wwwroot and logs folder.
Paste the following content in the Dockerfile.</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">FROM microsoft/aspnet:1.0.0-rc1-update1-coreclr

COPY <span class="nb">.</span> /app
WORKDIR /app/approot

EXPOSE &lt;PORT&gt;
ENTRYPOINT <span class="o">[</span><span class="s2">"./web"</span><span class="o">]</span></code></pre></figure>

<ul>
  <li><code class="highlighter-rouge">FROM microsoft/aspnet:1.0.0-rc1-update1-coreclr</code>: Docker creates the container on a base image. Docker runs each following instructions on top of this base image. Here we use aspnet image provided by Microsoft. To learn more visit the <a href="https://hub.docker.com/r/microsoft/aspnet/">docker hub</a>.</li>
  <li><code class="highlighter-rouge">COPY . /app</code>: Copy the current folder to <code class="highlighter-rouge">/app</code> folder in container.</li>
  <li><code class="highlighter-rouge">WORKDIR /app/approot</code>: Set the WORKDIR to /app/approot folder. This sets the working directory in container and executes remaining command from this directory.</li>
  <li><code class="highlighter-rouge">EXPOSE &lt;PORT&gt;</code>: <code class="highlighter-rouge">EXPOSE</code> instruction informs Docker that the container listens on the specified network ports at runtime. <code class="highlighter-rouge">EXPOSE</code> does not make the ports of the container accessible to the host. We will do that later during creating container. Substitute <PORT> for appropriate port as mentioned in project.json above.
</PORT>    <ul>
      <li>IdSrvHost: 22530</li>
      <li>Javascript Oidc: 7017</li>
      <li>SampleApi: 3860</li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">ENTRYPOINT ["./web"]</code>: This instruction will execute <code class="highlighter-rouge">web</code> script in current folder. Note that we had changed the working directory to <code class="highlighter-rouge">/app/approot</code>.</li>
</ul>

<h4 id="build-image">Build Image</h4>

<p>Go to the root of the published output of each project and run the following command to create a new image. This will download the base image from docker hub and may take time depending upon internet connection.</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nf">docker</span><span class="w"> </span><span class="nx">build</span><span class="w"> </span><span class="nt">-t</span><span class="w"> </span><span class="nx">idsrvhost</span><span class="w"> </span><span class="o">.</span></code></pre></figure>

<ul>
  <li><code class="highlighter-rouge">docker build</code>: Builds a new image from Dockerfile</li>
  <li><code class="highlighter-rouge">-t idsrvhost</code>: Sets the tag of the image.</li>
  <li><code class="highlighter-rouge">.</code>: The PATH to build the image from. By default docker searches for Dockerfile in PATH/Dockerfile.</li>
</ul>

<p><img src="/blog/assets/images/posts/Id4-on-docker/docker-build.png" alt="docker build" /></p>

<p>Do the same for each of the projects but change the tag name. Run <code class="highlighter-rouge">docker images</code> to view all the generated image.</p>

<p><img src="/blog/assets/images/posts/Id4-on-docker/docker-image.png" alt="docker images" /></p>

<h4 id="create-the-container">Create the container</h4>

<p>We will create one container for each image. Run the following commands to create and start the containers.</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nf">docker</span><span class="w"> </span><span class="nx">run</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="nt">-p</span><span class="w"> </span><span class="nx">22530:22530</span><span class="w"> </span><span class="nt">--name</span><span class="w"> </span><span class="nx">idsrv-host</span><span class="w"> </span><span class="nx">idsrvhost</span><span class="w">
</span><span class="nf">docker</span><span class="w"> </span><span class="nx">run</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="nt">-p</span><span class="w"> </span><span class="nx">7017:7017</span><span class="w"> </span><span class="nt">--name</span><span class="w"> </span><span class="nx">client</span><span class="w"> </span><span class="nx">jsclient</span><span class="w">
</span><span class="nf">docker</span><span class="w"> </span><span class="nx">run</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="nt">-p</span><span class="w"> </span><span class="nx">3860:3860</span><span class="w"> </span><span class="nt">--name</span><span class="w"> </span><span class="nx">api</span><span class="w"> </span><span class="nx">sampleapi</span></code></pre></figure>

<ul>
  <li><code class="highlighter-rouge">docker run</code>: Creates and start a new container.</li>
  <li><code class="highlighter-rouge">-d</code>: Run the container in background.</li>
  <li><code class="highlighter-rouge">-p &lt;host&gt;:&lt;container&gt;</code>: Map the specified port of host to the port container.</li>
  <li><code class="highlighter-rouge">--name &lt;ContainerName&gt;</code>: Creates the container with the specified name.</li>
  <li>The last parameter is the name of the image from which to create the container.</li>
</ul>

<p>Run <code class="highlighter-rouge">docker ps</code> to view all the created containers.</p>

<p><img src="/blog/assets/images/posts/Id4-on-docker/docker-ps.png" alt="docker ps" /></p>

<h4 id="thats-it">Thats it.</h4>

<p>Open the browser and go to the URL:PORT to view each of the site. Open URL:7017 to play with the javascript client.</p>

<p><img src="/blog/assets/images/posts/Id4-on-docker/client-running.png" alt="client" /></p>

<h3 id="conclusion">Conclusion</h3>
<p>Docker is great and very easy once you get hang of it. Next step you can try <code class="highlighter-rouge">-v</code> command to mount the source code to container without having to publish the site. This is incredibly helpful during development where you want to avoid hassle of publishing and creating new images every time you make a change.</p>

  </div>
  <div class="PageNavigation">
  
  <div class="prevDiv">
    <a class="prev"></a>
  </div>
  
  
  <div class="nextDiv">
    <a class="next" href="/blog/2016/08/IdentityServer4-on-Docker-netcorertm/">IdentityServer4 on Docker (ASP.NET Core 1.0) &raquo;</a>
  </div>
  
</div>
<!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="ankitbko/blog"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/blog/2016/03/IdentityServer4-on-Docker/" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/blog/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/blog/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/blog/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
        <ul class="contact-list">
          <li class="p-name">Ankit Sinha</li>
          
        </ul>
      </div>
      <div class="footer-col">
        <p>A technology blog focusing on random stuff</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/ankitbko" title="ankitbko"><svg class="svg-icon grey"><use xlink:href="/blog/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/ankitbko" title="ankitbko"><svg class="svg-icon grey"><use xlink:href="/blog/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
